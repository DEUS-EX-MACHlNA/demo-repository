<?xml version="1.0" encoding="UTF-8"?>
<mxfile host="app.diagrams.net" modified="2026-02-20" agent="Claude" version="24.0" type="device">
  <diagram id="condition-system" name="Condition DSL &amp; Lock/Ending ê´€ê³„ë„">
    <mxGraphModel dx="1400" dy="1000" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1800" pageHeight="1400" math="0" shadow="0">
      <root>
        <mxCell id="0"/>
        <mxCell id="1" parent="0"/>

        <mxCell id="title" value="&lt;b&gt;Condition DSL &amp;amp; Lock / Ending / Item ê´€ê³„ë„&lt;/b&gt;&lt;br&gt;ConditionEvaluator ì¤‘ì‹¬ì˜ ì¡°ê±´ í‰ê°€ ì‹œìŠ¤í…œ" style="text;html=1;align=center;fontSize=16;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="500" y="15" width="500" height="45" as="geometry"/>
        </mxCell>

        <!-- ===== ConditionEvaluator (Center) ===== -->
        <mxCell id="ce" value="&lt;b&gt;ConditionEvaluator&lt;/b&gt;&lt;hr&gt;&lt;div style='text-align:left;padding:6px;'&gt;&lt;b&gt;evaluate(condition, context)&lt;/b&gt; â†’ bool&lt;br&gt;&lt;br&gt;&lt;b&gt;ì§€ì› ì¡°ê±´ ë¬¸ë²•:&lt;/b&gt;&lt;br&gt;â€¢ npc.{id}.{stat} {op} {val}&lt;br&gt;â€¢ vars.{key} {op} {val}&lt;br&gt;â€¢ flags.{key} == true/false/null&lt;br&gt;â€¢ locks.{lock_id} == true/false&lt;br&gt;â€¢ has_item({item_id})&lt;br&gt;â€¢ system.turn {op} {val}&lt;br&gt;â€¢ system.turn == turn_limit&lt;br&gt;â€¢ area.{area}.{prop}&lt;br&gt;â€¢ area.current == '{area}'&lt;br&gt;â€¢ npc.target.* / target == '{val}'&lt;br&gt;&lt;br&gt;&lt;b&gt;ë…¼ë¦¬ ì—°ì‚°ìž:&lt;/b&gt; and / or&lt;br&gt;&lt;b&gt;ë¹„êµ ì—°ì‚°ìž:&lt;/b&gt; ==, !=, &amp;gt;=, &amp;lt;=, &amp;gt;, &amp;lt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=11;verticalAlign=top;align=center;" vertex="1" parent="1">
          <mxGeometry x="620" y="100" width="280" height="310" as="geometry"/>
        </mxCell>

        <!-- EvalContext -->
        <mxCell id="ctx" value="&lt;b&gt;EvalContext&lt;/b&gt;&lt;hr&gt;&lt;div style='text-align:left;padding:4px;'&gt;world_state: WorldStatePipeline&lt;br&gt;turn_limit: int&lt;br&gt;target_npc_id: Optional[str]&lt;br&gt;current_item_id: Optional[str]&lt;br&gt;area: Optional[str]&lt;br&gt;phase: Optional[str]&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=10;verticalAlign=top;align=center;" vertex="1" parent="1">
          <mxGeometry x="640" y="440" width="240" height="140" as="geometry"/>
        </mxCell>
        <mxCell id="ce-ctx" value="input" style="html=1;endArrow=open;endFill=0;dashed=1;strokeWidth=1.5;fontSize=9;fontColor=#6c8ebf;" edge="1" parent="1" source="ctx" target="ce">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <!-- ===== 3 Consumers ===== -->

        <!-- 1. LockManager -->
        <mxCell id="lm-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#E8F5E9;strokeColor=#2E7D32;arcSize=5;" vertex="1" parent="1">
          <mxGeometry x="40" y="100" width="480" height="500" as="geometry"/>
        </mxCell>
        <mxCell id="lm-title" value="&lt;b&gt;LockManager&lt;/b&gt;&lt;br&gt;&lt;i&gt;check_unlocks(ws, locks_data) â†’ LockCheckResult&lt;/i&gt;" style="text;html=1;align=center;fontSize=13;fillColor=none;strokeColor=none;fontColor=#2E7D32;" vertex="1" parent="1">
          <mxGeometry x="60" y="105" width="440" height="35" as="geometry"/>
        </mxCell>

        <!-- Lock types -->
        <mxCell id="lk-quest" value="&lt;b&gt;quest_gate&lt;/b&gt;&lt;br&gt;í€˜ìŠ¤íŠ¸ ê²Œì´íŠ¸" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#C8E6C9;strokeColor=#2E7D32;fontSize=10;fontStyle=0;" vertex="1" parent="1">
          <mxGeometry x="60" y="155" width="200" height="35" as="geometry"/>
        </mxCell>
        <mxCell id="lk-item" value="&lt;b&gt;item_hint&lt;/b&gt;&lt;br&gt;ì•„ì´í…œ ížŒíŠ¸" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#C8E6C9;strokeColor=#2E7D32;fontSize=10;fontStyle=0;" vertex="1" parent="1">
          <mxGeometry x="280" y="155" width="200" height="35" as="geometry"/>
        </mxCell>
        <mxCell id="lk-npc" value="&lt;b&gt;npc_topic&lt;/b&gt;&lt;br&gt;NPC ëŒ€í™” ì£¼ì œ" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#C8E6C9;strokeColor=#2E7D32;fontSize=10;fontStyle=0;" vertex="1" parent="1">
          <mxGeometry x="60" y="205" width="200" height="35" as="geometry"/>
        </mxCell>
        <mxCell id="lk-lore" value="&lt;b&gt;lore&lt;/b&gt;&lt;br&gt;ì„¸ê³„ê´€ ì •ë³´" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#C8E6C9;strokeColor=#2E7D32;fontSize=10;fontStyle=0;" vertex="1" parent="1">
          <mxGeometry x="280" y="205" width="200" height="35" as="geometry"/>
        </mxCell>

        <!-- Lock examples -->
        <mxCell id="lk-ex1" value="&lt;div style='text-align:left;'&gt;&lt;b&gt;locks.yaml ì˜ˆì‹œ&lt;/b&gt;&lt;br&gt;&lt;br&gt;&lt;code&gt;- id: basement_key_hint&lt;br&gt;&amp;nbsp;&amp;nbsp;type: item_hint&lt;br&gt;&amp;nbsp;&amp;nbsp;unlock_condition:&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&quot;npc.stepfather.affection &amp;gt;= 60&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;and system.turn &amp;gt;= 5&quot;&lt;br&gt;&amp;nbsp;&amp;nbsp;summary: &quot;ì§€í•˜ì‹¤ ì—´ì‡  ìœ„ì¹˜ ížŒíŠ¸&quot;&lt;br&gt;&amp;nbsp;&amp;nbsp;inject_memory: &quot;ìƒˆì•„ë¹ ê°€ ì§€í•˜ì‹¤ì—&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;ì—´ì‡ ê°€ ìžˆë‹¤ê³  ë§í–ˆë‹¤&quot;&lt;br&gt;&amp;nbsp;&amp;nbsp;access:&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;allowed_npcs:&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;- stepfather&lt;/code&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#FFFFFF;strokeColor=#2E7D32;fontSize=9;align=left;spacingLeft=8;fontFamily=monospace;" vertex="1" parent="1">
          <mxGeometry x="60" y="260" width="420" height="220" as="geometry"/>
        </mxCell>

        <!-- Arrow: Lock flow -->
        <mxCell id="lk-flow" value="&lt;div style='text-align:left;'&gt;&lt;b&gt;Lock í•´ì œ íë¦„:&lt;/b&gt;&lt;br&gt;1. ë§¤ í„´ check_unlocks() í˜¸ì¶œ&lt;br&gt;2. ConditionEvaluatorë¡œ ì¡°ê±´ í‰ê°€&lt;br&gt;3. ì¡°ê±´ ì¶©ì¡± â†’ _unlocked_idsì— ì¶”ê°€&lt;br&gt;4. inject_memory â†’ í•´ë‹¹ NPC memoryì— ì €ìž¥&lt;br&gt;5. NPCê°€ unlockëœ ì •ë³´ë¥¼ ëŒ€í™”ì—ì„œ ì‚¬ìš©&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#E8F5E9;strokeColor=#2E7D32;fontSize=9;align=left;spacingLeft=8;" vertex="1" parent="1">
          <mxGeometry x="60" y="500" width="420" height="90" as="geometry"/>
        </mxCell>

        <!-- Arrow LM -> CE -->
        <mxCell id="lm-ce" value="evaluate(unlock_condition)" style="html=1;endArrow=block;endFill=1;strokeWidth=2;fontSize=10;strokeColor=#2E7D32;" edge="1" parent="1" source="lm-box" target="ce">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <!-- 2. EndingChecker -->
        <mxCell id="ec-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFEBEE;strokeColor=#C62828;arcSize=5;" vertex="1" parent="1">
          <mxGeometry x="1000" y="100" width="500" height="480" as="geometry"/>
        </mxCell>
        <mxCell id="ec-title" value="&lt;b&gt;EndingChecker&lt;/b&gt;&lt;br&gt;&lt;i&gt;check(ws, assets, skip_has_item) â†’ EndingCheckResult&lt;/i&gt;" style="text;html=1;align=center;fontSize=13;fillColor=none;strokeColor=none;fontColor=#C62828;" vertex="1" parent="1">
          <mxGeometry x="1020" y="105" width="460" height="35" as="geometry"/>
        </mxCell>

        <!-- Endings -->
        <mxCell id="end-v1" value="&lt;b&gt;ðŸ† stealth_exit&lt;/b&gt;&lt;br&gt;&lt;code&gt;has_item(old_key)&lt;br&gt;and flags.door_unlocked == true&lt;br&gt;and npc.stepmother.status == SLEEPING&lt;/code&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#C8E6C9;strokeColor=#2E7D32;fontSize=9;align=left;spacingLeft=8;" vertex="1" parent="1">
          <mxGeometry x="1020" y="155" width="460" height="60" as="geometry"/>
        </mxCell>
        <mxCell id="end-v2" value="&lt;b&gt;ðŸ† chaotic_breakout&lt;/b&gt;&lt;br&gt;&lt;code&gt;has_item(matches)&lt;br&gt;and flags.house_on_fire == true&lt;br&gt;and flags.door_unlocked == true&lt;/code&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#C8E6C9;strokeColor=#2E7D32;fontSize=9;align=left;spacingLeft=8;" vertex="1" parent="1">
          <mxGeometry x="1020" y="225" width="460" height="60" as="geometry"/>
        </mxCell>
        <mxCell id="end-v3" value="&lt;b&gt;ðŸ† sibling_sacrifice&lt;/b&gt;&lt;br&gt;&lt;code&gt;npc.brother.humanity &gt;= 80&lt;br&gt;and has_item(brother_doll)&lt;br&gt;and flags.brother_ally == true&lt;/code&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#C8E6C9;strokeColor=#2E7D32;fontSize=9;align=left;spacingLeft=8;" vertex="1" parent="1">
          <mxGeometry x="1020" y="295" width="460" height="60" as="geometry"/>
        </mxCell>
        <mxCell id="end-d1" value="&lt;b&gt;ðŸ’€ captured (ë¯¸ì™„ì„± ì¸í˜•)&lt;/b&gt;&lt;br&gt;&lt;code&gt;npc.stepmother.affection &lt;= 10&lt;br&gt;and npc.stepmother.fear &gt;= 95&lt;br&gt;and flags.caught == true&lt;/code&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFCDD2;strokeColor=#C62828;fontSize=9;align=left;spacingLeft=8;" vertex="1" parent="1">
          <mxGeometry x="1020" y="365" width="460" height="60" as="geometry"/>
        </mxCell>
        <mxCell id="end-d2" value="&lt;b&gt;ðŸ’€ turn_limit (ì˜ì›í•œ ì €ë…ì‹ì‚¬)&lt;/b&gt;&lt;br&gt;&lt;code&gt;system.turn == turn_limit&lt;/code&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFCDD2;strokeColor=#C62828;fontSize=9;align=left;spacingLeft=8;" vertex="1" parent="1">
          <mxGeometry x="1020" y="435" width="460" height="45" as="geometry"/>
        </mxCell>

        <!-- on_enter_events -->
        <mxCell id="ec-events" value="&lt;div style='text-align:left;'&gt;&lt;b&gt;on_enter_events&lt;/b&gt;&lt;br&gt;ì—”ë”© ë„ë‹¬ ì‹œ ì¶”ê°€ ìƒíƒœ ë³€í™”&lt;br&gt;â†’ _events_to_delta() â†’ StateDelta&lt;br&gt;&lt;i&gt;ì˜ˆ: status ë³€ê²½, flag ì„¤ì •&lt;/i&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#FFEBEE;strokeColor=#C62828;fontSize=9;align=left;spacingLeft=8;" vertex="1" parent="1">
          <mxGeometry x="1020" y="500" width="460" height="65" as="geometry"/>
        </mxCell>

        <!-- Arrow EC -> CE -->
        <mxCell id="ec-ce" value="evaluate(ending.condition)" style="html=1;endArrow=block;endFill=1;strokeWidth=2;fontSize=10;strokeColor=#C62828;" edge="1" parent="1" source="ec-box" target="ce">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <!-- 3. ItemAcquirer -->
        <mxCell id="ia-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFF3E0;strokeColor=#E65100;arcSize=5;" vertex="1" parent="1">
          <mxGeometry x="40" y="650" width="480" height="350" as="geometry"/>
        </mxCell>
        <mxCell id="ia-title" value="&lt;b&gt;ItemAcquirer&lt;/b&gt;&lt;br&gt;&lt;i&gt;scan(ws, assets) â†’ AcquisitionResult&lt;/i&gt;" style="text;html=1;align=center;fontSize=13;fillColor=none;strokeColor=none;fontColor=#E65100;" vertex="1" parent="1">
          <mxGeometry x="60" y="655" width="440" height="35" as="geometry"/>
        </mxCell>

        <mxCell id="ia-methods" value="&lt;div style='text-align:left;'&gt;&lt;b&gt;ì•„ì´í…œ íšë“ ë°©ì‹ (acquire.method)&lt;/b&gt;&lt;br&gt;&lt;br&gt;â€¢ &lt;b&gt;start&lt;/b&gt;: ê²Œìž„ ì‹œìž‘ ì‹œ ìžë™ ë³´ìœ &lt;br&gt;â€¢ &lt;b&gt;auto&lt;/b&gt;: ë§¤ í„´ scan() â†’ ì¡°ê±´ ì¶©ì¡± ì‹œ ìžë™ íšë“&lt;br&gt;â€¢ &lt;b&gt;manual&lt;/b&gt;: LLMì´ tool_callë¡œ ì§ì ‘ íšë“ íŒë‹¨&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#FFFFFF;strokeColor=#E65100;fontSize=10;align=left;spacingLeft=8;" vertex="1" parent="1">
          <mxGeometry x="60" y="700" width="440" height="90" as="geometry"/>
        </mxCell>

        <mxCell id="ia-ex" value="&lt;div style='text-align:left;'&gt;&lt;b&gt;items.yaml ì˜ˆì‹œ (auto acquire)&lt;/b&gt;&lt;br&gt;&lt;br&gt;&lt;code&gt;- id: old_key&lt;br&gt;&amp;nbsp;&amp;nbsp;name: ë‚¡ì€ ì—´ì‡ &lt;br&gt;&amp;nbsp;&amp;nbsp;acquire:&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;method: auto&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;condition:&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&quot;area.current == 'basement'&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;and system.turn &amp;gt;= 3&quot;&lt;br&gt;&amp;nbsp;&amp;nbsp;use:&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;actions:&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;unlock_door:&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;allowed_when: &quot;...&quot;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;effect: { set_flag: ... }&lt;/code&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#FFFFFF;strokeColor=#E65100;fontSize=9;align=left;spacingLeft=8;fontFamily=monospace;" vertex="1" parent="1">
          <mxGeometry x="60" y="805" width="440" height="180" as="geometry"/>
        </mxCell>

        <!-- Arrow IA -> CE -->
        <mxCell id="ia-ce" value="evaluate(acquire.condition)" style="html=1;endArrow=block;endFill=1;strokeWidth=2;fontSize=10;strokeColor=#E65100;" edge="1" parent="1" source="ia-box" target="ce">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <!-- 4. ItemUseResolver (connected) -->
        <mxCell id="iur-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FCE4EC;strokeColor=#AD1457;arcSize=5;" vertex="1" parent="1">
          <mxGeometry x="620" y="650" width="360" height="350" as="geometry"/>
        </mxCell>
        <mxCell id="iur-title" value="&lt;b&gt;ItemUseResolver&lt;/b&gt;&lt;br&gt;&lt;i&gt;ì•„ì´í…œ ì‚¬ìš© ì‹œ ì¡°ê±´ + íš¨ê³¼ ì ìš©&lt;/i&gt;" style="text;html=1;align=center;fontSize=13;fillColor=none;strokeColor=none;fontColor=#AD1457;" vertex="1" parent="1">
          <mxGeometry x="640" y="655" width="320" height="35" as="geometry"/>
        </mxCell>

        <mxCell id="iur-flow" value="&lt;div style='text-align:left;'&gt;&lt;b&gt;ì•„ì´í…œ ì‚¬ìš© íë¦„&lt;/b&gt;&lt;br&gt;&lt;br&gt;1. Tools: use(item_id, action_id) í˜¸ì¶œ&lt;br&gt;2. items.yamlì—ì„œ action ì¡°íšŒ&lt;br&gt;3. &lt;b&gt;allowed_when&lt;/b&gt; ì¡°ê±´ í‰ê°€&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;â†’ ConditionEvaluator&lt;br&gt;4. ì¡°ê±´ í†µê³¼ â†’ &lt;b&gt;effect&lt;/b&gt; ì ìš©&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;â†’ EffectApplicator&lt;br&gt;5. StatusEffectê°€ ìžˆìœ¼ë©´&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;â†’ StatusEffectManager.apply_effect()&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#FFFFFF;strokeColor=#AD1457;fontSize=10;align=left;spacingLeft=8;" vertex="1" parent="1">
          <mxGeometry x="640" y="700" width="320" height="160" as="geometry"/>
        </mxCell>

        <mxCell id="iur-effects" value="&lt;div style='text-align:left;'&gt;&lt;b&gt;effect ì¢…ë¥˜ (EffectApplicator)&lt;/b&gt;&lt;br&gt;&lt;br&gt;â€¢ stat_change: NPC stat ë³€ê²½&lt;br&gt;â€¢ set_flag: flag ì„¤ì •&lt;br&gt;â€¢ set_var: vars ì„¤ì •&lt;br&gt;â€¢ add_item / remove_item&lt;br&gt;â€¢ status_effect: ì‹œê°„ì œ ìƒíƒœ (SLEEPING ë“±)&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#FFFFFF;strokeColor=#AD1457;fontSize=10;align=left;spacingLeft=8;" vertex="1" parent="1">
          <mxGeometry x="640" y="875" width="320" height="110" as="geometry"/>
        </mxCell>

        <!-- Arrow IUR -> CE -->
        <mxCell id="iur-ce" value="evaluate(allowed_when)" style="html=1;endArrow=block;endFill=1;strokeWidth=2;fontSize=10;strokeColor=#AD1457;" edge="1" parent="1" source="iur-box" target="ce">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <!-- Central dependency visual -->
        <mxCell id="center-note" value="&lt;div style='text-align:center;'&gt;&lt;b&gt;ConditionEvaluatorëŠ”&lt;br&gt;4ê°œ ì»´í¬ë„ŒíŠ¸ì—ì„œ ê³µìœ &lt;/b&gt;&lt;br&gt;&lt;br&gt;ë™ì¼í•œ DSL ë¬¸ë²•ìœ¼ë¡œ&lt;br&gt;Lock, Ending, Item Acquire,&lt;br&gt;Item Use ì¡°ê±´ì„ í‰ê°€&lt;/div&gt;" style="shape=hexagon;perimeter=hexagonPerimeter2;whiteSpace=wrap;html=1;fixedSize=1;fillColor=#FFF8E1;strokeColor=#d6b656;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1100" y="650" width="220" height="120" as="geometry"/>
        </mxCell>

      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
