<?xml version="1.0" encoding="UTF-8"?>
<mxfile host="app.diagrams.net" modified="2026-02-20" agent="Claude" version="24.0" type="device">
  <diagram id="state-diagram" name="ê²Œìž„ ìƒíƒœ ë‹¤ì´ì–´ê·¸ëž¨">
    <mxGraphModel dx="1400" dy="1000" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1600" pageHeight="1400" math="0" shadow="0">
      <root>
        <mxCell id="0"/>
        <mxCell id="1" parent="0"/>

        <mxCell id="title" value="&lt;b&gt;ê²Œìž„ ìƒíƒœ ë‹¤ì´ì–´ê·¸ëž¨&lt;/b&gt;&lt;br&gt;GameStatus, NPC Phase, NPCStatus ì „ì´" style="text;html=1;align=center;fontSize=18;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="500" y="15" width="450" height="45" as="geometry"/>
        </mxCell>

        <!-- ===== 1. GameStatus State Machine ===== -->
        <mxCell id="gs-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#E3F2FD;strokeColor=#1565C0;arcSize=5;" vertex="1" parent="1">
          <mxGeometry x="40" y="80" width="700" height="220" as="geometry"/>
        </mxCell>
        <mxCell id="gs-title" value="&lt;b&gt;1. GameStatus ì „ì´&lt;/b&gt;" style="text;html=1;align=left;fontSize=14;fontStyle=0;fillColor=none;strokeColor=none;fontColor=#1565C0;" vertex="1" parent="1">
          <mxGeometry x="60" y="85" width="250" height="25" as="geometry"/>
        </mxCell>

        <!-- Initial -->
        <mxCell id="gs-init" value="" style="ellipse;whiteSpace=wrap;html=1;fillColor=#333333;strokeColor=#333333;" vertex="1" parent="1">
          <mxGeometry x="80" y="155" width="25" height="25" as="geometry"/>
        </mxCell>

        <!-- LIVE -->
        <mxCell id="gs-live" value="&lt;b&gt;LIVE&lt;/b&gt;&lt;br&gt;ê²Œìž„ ì§„í–‰ ì¤‘" style="ellipse;whiteSpace=wrap;html=1;fillColor=#BBDEFB;strokeColor=#1565C0;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="180" y="130" width="150" height="75" as="geometry"/>
        </mxCell>
        <mxCell id="gs-a1" value="start_game()" style="html=1;endArrow=block;endFill=1;strokeWidth=2;fontSize=9;" edge="1" parent="1" source="gs-init" target="gs-live">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <!-- Day/Night cycle -->
        <mxCell id="gs-day" value="&lt;b&gt;DAY&lt;/b&gt;&lt;br&gt;process_turn()" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFF9C4;strokeColor=#F9A825;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="400" y="115" width="120" height="45" as="geometry"/>
        </mxCell>
        <mxCell id="gs-night" value="&lt;b&gt;NIGHT&lt;/b&gt;&lt;br&gt;process_night()" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#CE93D8;strokeColor=#7B1FA2;fontSize=10;fontColor=#FFFFFF;" vertex="1" parent="1">
          <mxGeometry x="400" y="180" width="120" height="45" as="geometry"/>
        </mxCell>

        <mxCell id="gs-dn" value="" style="html=1;endArrow=block;endFill=1;strokeWidth=1.5;curved=1;" edge="1" parent="1" source="gs-day" target="gs-night">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="gs-nd" value="" style="html=1;endArrow=block;endFill=1;strokeWidth=1.5;curved=1;" edge="1" parent="1" source="gs-night" target="gs-day">
          <mxGeometry relative="1" as="geometry"><Array as="points"><mxPoint x="550" y="170"/></Array></mxGeometry>
        </mxCell>

        <mxCell id="gs-ld" style="html=1;endArrow=block;endFill=1;strokeWidth=1.5;" edge="1" parent="1" source="gs-live" target="gs-day">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <!-- ENDING -->
        <mxCell id="gs-ending" value="&lt;b&gt;ENDING&lt;/b&gt;&lt;br&gt;ì—”ë”© ë„ë‹¬" style="ellipse;whiteSpace=wrap;html=1;fillColor=#EF9A9A;strokeColor=#C62828;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="590" y="130" width="130" height="75" as="geometry"/>
        </mxCell>
        <mxCell id="gs-de" value="EndingChecker&lt;br&gt;.check() = true" style="html=1;endArrow=block;endFill=1;strokeWidth=2;fontSize=9;" edge="1" parent="1" source="gs-day" target="gs-ending">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="gs-ne" value="EndingChecker&lt;br&gt;.check() = true" style="html=1;endArrow=block;endFill=1;strokeWidth=2;fontSize=9;" edge="1" parent="1" source="gs-night" target="gs-ending">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <!-- ===== 2. NPC Phase State Machine (ìƒˆì—„ë§ˆ ì˜ˆì‹œ) ===== -->
        <mxCell id="np-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFF3E0;strokeColor=#E65100;arcSize=5;" vertex="1" parent="1">
          <mxGeometry x="40" y="330" width="1500" height="400" as="geometry"/>
        </mxCell>
        <mxCell id="np-title" value="&lt;b&gt;2. NPC Phase ì „ì´ (ìƒˆì—„ë§ˆ stepmother ì˜ˆì‹œ)&lt;/b&gt;&lt;br&gt;&lt;i&gt;ê° NPCëŠ” 3ê°œ Phaseë¥¼ ê°€ì§€ë©°, stats ì¡°ê±´ì— ë”°ë¼ ì „ì´. Night Reflectionì—ì„œ í‰ê°€ë¨&lt;/i&gt;" style="text;html=1;align=left;fontSize=13;fillColor=none;strokeColor=none;fontColor=#E65100;" vertex="1" parent="1">
          <mxGeometry x="60" y="335" width="600" height="40" as="geometry"/>
        </mxCell>

        <!-- Phase A -->
        <mxCell id="ph-a" value="&lt;b&gt;Phase A&lt;/b&gt;&lt;br&gt;&lt;b&gt;Pleasant (ë‹¤ì •í•œ ì¸í˜•)&lt;/b&gt;&lt;hr&gt;&lt;div style='text-align:left;font-size:10px;'&gt;í–‰ë™: ë”°ëœ»í•˜ê²Œ ëŒ€í•˜ë©° &quot;ê°€ì¡±&quot;ì„ ê°•ì¡°&lt;br&gt;ëª©í‘œ: í”Œë ˆì´ì–´ë¥¼ ê°€ì¡±ìœ¼ë¡œ ë§Œë“¤ê¸°&lt;br&gt;í†¤: ë¶€ë“œëŸ½ê³  ìƒëƒ¥í•œ ë§íˆ¬&lt;br&gt;&lt;br&gt;ì´ˆê¸° stats:&lt;br&gt;affection=50, fear=80, humanity=0&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#C8E6C9;strokeColor=#2E7D32;fontSize=11;verticalAlign=top;" vertex="1" parent="1">
          <mxGeometry x="80" y="400" width="260" height="180" as="geometry"/>
        </mxCell>

        <!-- Phase B -->
        <mxCell id="ph-b" value="&lt;b&gt;Phase B&lt;/b&gt;&lt;br&gt;&lt;b&gt;Testing (ì‹œí—˜í•˜ëŠ” ì¸í˜•)&lt;/b&gt;&lt;hr&gt;&lt;div style='text-align:left;font-size:10px;'&gt;í–‰ë™: ë¯¸ë¬˜í•œ ìœ„í˜‘ê³¼ ì‹œí—˜&lt;br&gt;ëª©í‘œ: ìˆœì¢… ì—¬ë¶€ í™•ì¸&lt;br&gt;í†¤: ì°¨ê°€ì›Œì§€ê³  ì˜ì‹¬ í‘œí˜„&lt;br&gt;&lt;br&gt;ì „ì´ ì¡°ê±´:&lt;br&gt;affection &lt;= 40 OR fear &gt;= 70&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFF9C4;strokeColor=#F9A825;fontSize=11;verticalAlign=top;" vertex="1" parent="1">
          <mxGeometry x="480" y="400" width="260" height="180" as="geometry"/>
        </mxCell>

        <!-- Phase C -->
        <mxCell id="ph-c" value="&lt;b&gt;Phase C&lt;/b&gt;&lt;br&gt;&lt;b&gt;Punishment (ì²˜ë²Œí•˜ëŠ” ì¸í˜•)&lt;/b&gt;&lt;hr&gt;&lt;div style='text-align:left;font-size:10px;'&gt;í–‰ë™: ì ê·¹ì  ìœ„í˜‘ê³¼ ê°ê¸ˆ&lt;br&gt;ëª©í‘œ: í”Œë ˆì´ì–´ ì™„ì „ ì œì••&lt;br&gt;í†¤: ë¬´ì„­ê³  ê³µê²©ì &lt;br&gt;&lt;br&gt;ì „ì´ ì¡°ê±´:&lt;br&gt;affection &lt;= 20 OR fear &gt;= 90&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFCDD2;strokeColor=#C62828;fontSize=11;verticalAlign=top;" vertex="1" parent="1">
          <mxGeometry x="880" y="400" width="260" height="180" as="geometry"/>
        </mxCell>

        <!-- Phase arrows -->
        <mxCell id="pa-ab" value="&lt;b&gt;affection â‰¤ 40&lt;br&gt;OR fear â‰¥ 70&lt;/b&gt;" style="html=1;endArrow=block;endFill=1;strokeWidth=2.5;fontSize=10;fontColor=#E65100;" edge="1" parent="1" source="ph-a" target="ph-b">
          <mxGeometry x="0.1" relative="1" as="geometry"><mxPoint as="offset"/></mxGeometry>
        </mxCell>
        <mxCell id="pa-bc" value="&lt;b&gt;affection â‰¤ 20&lt;br&gt;OR fear â‰¥ 90&lt;/b&gt;" style="html=1;endArrow=block;endFill=1;strokeWidth=2.5;fontSize=10;fontColor=#E65100;" edge="1" parent="1" source="ph-b" target="ph-c">
          <mxGeometry x="0.1" relative="1" as="geometry"><mxPoint as="offset"/></mxGeometry>
        </mxCell>

        <!-- Reflection note -->
        <mxCell id="np-reflect" value="&lt;div style='text-align:left;'&gt;&lt;b&gt;Phase ì „ì´ í‰ê°€ ì‹œì &lt;/b&gt;&lt;br&gt;&lt;br&gt;Night Phase 1: _run_reflections()&lt;br&gt;â”œ determine_current_phase()&lt;br&gt;â”œ should_reflect()?&lt;br&gt;â”” perform_reflection() â†’ Memory&lt;br&gt;&lt;br&gt;Phase ë³€ê²½ ì‹œ NPCì˜ í–‰ë™/ë§íˆ¬ê°€&lt;br&gt;ì™„ì „ížˆ ë°”ë€œ (persona ìž¬í•´ì„)&lt;/div&gt;" style="shape=note;whiteSpace=wrap;html=1;backgroundOutline=1;size=18;fillColor=#FFF8E1;strokeColor=#d6b656;fontSize=10;align=left;spacingLeft=8;" vertex="1" parent="1">
          <mxGeometry x="1200" y="400" width="280" height="170" as="geometry"/>
        </mxCell>

        <!-- Other NPCs -->
        <mxCell id="np-others" value="&lt;div style='text-align:left;'&gt;&lt;b&gt;ë‹¤ë¥¸ NPC Phase êµ¬ì¡°&lt;/b&gt;&lt;br&gt;&lt;br&gt;ðŸ‘¨ ìƒˆì•„ë¹ : A(Silent) â†’ B(Conflicted) â†’ C(Aggressive)&lt;br&gt;ðŸ‘¦ ì˜¤ë¹ : A(Awkward) â†’ B(Curious) â†’ C(Ally / Broken)&lt;br&gt;ðŸ‘µ í• ë¨¸ë‹ˆ: A(Watchful) â†’ B(Warning) â†’ C(Intervening)&lt;br&gt;ðŸ• ë°”ë¡ : A(Neutral) â†’ B(Alert) â†’ C(Guardian)&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFF3E0;strokeColor=#E65100;fontSize=10;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="80" y="620" width="500" height="90" as="geometry"/>
        </mxCell>

        <!-- ===== 3. NPCStatus State Machine ===== -->
        <mxCell id="ns-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#F3E5F5;strokeColor=#7B1FA2;arcSize=5;" vertex="1" parent="1">
          <mxGeometry x="40" y="770" width="1500" height="300" as="geometry"/>
        </mxCell>
        <mxCell id="ns-title" value="&lt;b&gt;3. NPCStatus ì „ì´ (NPC ìƒì¡´ ìƒíƒœ)&lt;/b&gt;&lt;br&gt;&lt;i&gt;StatusEffectManagerê°€ ê´€ë¦¬í•˜ëŠ” ì‹œê°„ì œ ìƒíƒœ í¬í•¨&lt;/i&gt;" style="text;html=1;align=left;fontSize=13;fillColor=none;strokeColor=none;fontColor=#7B1FA2;" vertex="1" parent="1">
          <mxGeometry x="60" y="775" width="500" height="40" as="geometry"/>
        </mxCell>

        <!-- ALIVE -->
        <mxCell id="ns-alive" value="&lt;b&gt;ALIVE&lt;/b&gt;&lt;br&gt;(í™œì„±)" style="ellipse;whiteSpace=wrap;html=1;fillColor=#C8E6C9;strokeColor=#2E7D32;fontSize=13;" vertex="1" parent="1">
          <mxGeometry x="120" y="860" width="140" height="70" as="geometry"/>
        </mxCell>

        <!-- SLEEPING -->
        <mxCell id="ns-sleeping" value="&lt;b&gt;SLEEPING&lt;/b&gt;&lt;br&gt;(ìˆ˜ë©´ - ì‹œê°„ì œ)" style="ellipse;whiteSpace=wrap;html=1;fillColor=#BBDEFB;strokeColor=#1565C0;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="380" y="830" width="160" height="70" as="geometry"/>
        </mxCell>

        <!-- MISSING -->
        <mxCell id="ns-missing" value="&lt;b&gt;MISSING&lt;/b&gt;&lt;br&gt;(ì‹¤ì¢…)" style="ellipse;whiteSpace=wrap;html=1;fillColor=#FFF9C4;strokeColor=#F9A825;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="380" y="930" width="160" height="70" as="geometry"/>
        </mxCell>

        <!-- DECEASED -->
        <mxCell id="ns-deceased" value="&lt;b&gt;DECEASED&lt;/b&gt;&lt;br&gt;(ì‚¬ë§ - ìµœì¢…)" style="ellipse;whiteSpace=wrap;html=1;fillColor=#FFCDD2;strokeColor=#C62828;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="660" y="860" width="160" height="70" as="geometry"/>
        </mxCell>

        <!-- UNKNOWN -->
        <mxCell id="ns-unknown" value="&lt;b&gt;UNKNOWN&lt;/b&gt;&lt;br&gt;(ë¶ˆëª…)" style="ellipse;whiteSpace=wrap;html=1;fillColor=#F5F5F5;strokeColor=#999999;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="660" y="960" width="140" height="60" as="geometry"/>
        </mxCell>

        <!-- Transitions -->
        <mxCell id="ns-a-sl" value="use(sedative_herb)&lt;br&gt;â†’ StatusEffect(3í„´)" style="html=1;endArrow=block;endFill=1;strokeWidth=2;fontSize=9;" edge="1" parent="1" source="ns-alive" target="ns-sleeping">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="ns-sl-a" value="tick(): duration ë§Œë£Œ" style="html=1;endArrow=block;endFill=1;strokeWidth=2;fontSize=9;dashed=1;dashPattern=5 3;" edge="1" parent="1" source="ns-sleeping" target="ns-alive">
          <mxGeometry relative="1" as="geometry"><Array as="points"><mxPoint x="300" y="850"/></Array></mxGeometry>
        </mxCell>
        <mxCell id="ns-a-mi" value="íŠ¹ì • ì´ë²¤íŠ¸" style="html=1;endArrow=block;endFill=1;strokeWidth=2;fontSize=9;" edge="1" parent="1" source="ns-alive" target="ns-missing">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="ns-a-de" value="ì¹˜ëª…ì  ì´ë²¤íŠ¸" style="html=1;endArrow=block;endFill=1;strokeWidth=2;fontSize=9;strokeColor=#C62828;" edge="1" parent="1" source="ns-alive" target="ns-deceased">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="ns-mi-de" value="" style="html=1;endArrow=block;endFill=1;strokeWidth=1.5;fontSize=9;strokeColor=#C62828;" edge="1" parent="1" source="ns-missing" target="ns-deceased">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="ns-mi-a" value="ë³µê·€" style="html=1;endArrow=block;endFill=1;strokeWidth=1.5;fontSize=9;dashed=1;" edge="1" parent="1" source="ns-missing" target="ns-alive">
          <mxGeometry relative="1" as="geometry"><Array as="points"><mxPoint x="190" y="970"/></Array></mxGeometry>
        </mxCell>

        <!-- StatusEffect note -->
        <mxCell id="ns-se-note" value="&lt;div style='text-align:left;'&gt;&lt;b&gt;StatusEffectManager&lt;/b&gt;&lt;br&gt;&lt;br&gt;apply_effect(effect, ws):&lt;br&gt;â€¢ NPC status ë³€ê²½ (â†’ SLEEPING)&lt;br&gt;â€¢ vars[&quot;status_effects&quot;]ì— ì €ìž¥&lt;br&gt;â€¢ { npc_id, status, expires_at_turn,&lt;br&gt;&amp;nbsp;&amp;nbsp;original_status }&lt;br&gt;&lt;br&gt;tick(current_turn, ws):&lt;br&gt;â€¢ ë§¤ í„´ ì‹œìž‘ ì‹œ í˜¸ì¶œ&lt;br&gt;â€¢ expires_at_turn &lt;= current_turn&lt;br&gt;&amp;nbsp;&amp;nbsp;â†’ original_statusë¡œ ë³µì›&lt;/div&gt;" style="shape=note;whiteSpace=wrap;html=1;backgroundOutline=1;size=18;fillColor=#FFF8E1;strokeColor=#d6b656;fontSize=10;align=left;spacingLeft=8;" vertex="1" parent="1">
          <mxGeometry x="920" y="830" width="290" height="200" as="geometry"/>
        </mxCell>

        <!-- Final state marker for DECEASED -->
        <mxCell id="ns-final" value="" style="ellipse;whiteSpace=wrap;html=1;fillColor=#333333;strokeColor=#333333;" vertex="1" parent="1">
          <mxGeometry x="840" y="882" width="20" height="20" as="geometry"/>
        </mxCell>
        <mxCell id="ns-de-f" style="html=1;endArrow=block;endFill=1;strokeWidth=1.5;" edge="1" parent="1" source="ns-deceased" target="ns-final">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <!-- ===== 4. Turn Lifecycle ===== -->
        <mxCell id="tl-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ECEFF1;strokeColor=#546E7A;arcSize=5;" vertex="1" parent="1">
          <mxGeometry x="40" y="1100" width="700" height="250" as="geometry"/>
        </mxCell>
        <mxCell id="tl-title" value="&lt;b&gt;4. í„´ ë¼ì´í”„ì‚¬ì´í´&lt;/b&gt;" style="text;html=1;align=left;fontSize=14;fillColor=none;strokeColor=none;fontColor=#546E7A;" vertex="1" parent="1">
          <mxGeometry x="60" y="1105" width="250" height="25" as="geometry"/>
        </mxCell>

        <mxCell id="tl-1" value="&lt;b&gt;Turn N (Day)&lt;/b&gt;&lt;br&gt;Lock â†’ StatusTick&lt;br&gt;â†’ DayCtrl â†’ Delta&lt;br&gt;â†’ ItemScan â†’ Ending" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFF9C4;strokeColor=#F9A825;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="80" y="1160" width="150" height="70" as="geometry"/>
        </mxCell>
        <mxCell id="tl-2" value="&lt;b&gt;Turn N (Night)&lt;/b&gt;&lt;br&gt;Reflect â†’ Plan&lt;br&gt;â†’ Dialogue â†’ Impact&lt;br&gt;â†’ Delta â†’ Ending" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#CE93D8;strokeColor=#7B1FA2;fontSize=10;fontColor=#FFFFFF;" vertex="1" parent="1">
          <mxGeometry x="290" y="1160" width="150" height="70" as="geometry"/>
        </mxCell>
        <mxCell id="tl-3" value="&lt;b&gt;Turn N+1 (Day)&lt;/b&gt;&lt;br&gt;turn++ (day_action_log&lt;br&gt;ì´ˆê¸°í™”ë¨)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFF9C4;strokeColor=#F9A825;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="500" y="1160" width="150" height="70" as="geometry"/>
        </mxCell>

        <mxCell id="tl-a1" style="html=1;endArrow=block;endFill=1;strokeWidth=2;" edge="1" parent="1" source="tl-1" target="tl-2"><mxGeometry relative="1" as="geometry"/></mxCell>
        <mxCell id="tl-a2" style="html=1;endArrow=block;endFill=1;strokeWidth=2;" edge="1" parent="1" source="tl-2" target="tl-3"><mxGeometry relative="1" as="geometry"/></mxCell>

        <mxCell id="tl-limit" value="&lt;b&gt;Turn 50&lt;/b&gt;&lt;br&gt;= turn_limit&lt;br&gt;â†’ ê°•ì œ ì—”ë”©" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#FFCDD2;strokeColor=#C62828;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="500" y="1265" width="150" height="50" as="geometry"/>
        </mxCell>
        <mxCell id="tl-a3" value="system.turn == turn_limit" style="html=1;endArrow=block;endFill=1;strokeWidth=1.5;dashed=1;fontSize=9;strokeColor=#C62828;" edge="1" parent="1" source="tl-3" target="tl-limit">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
