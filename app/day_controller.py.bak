"""
app/day_controller.py
Day Phase Controller (ScenarioController)

낮 페이즈에서 사용자 입력을 처리하고 Tool을 실행합니다.
- Tool Calling (LLM이 직접 tool 선택)
- Tool 실행 (interact, action, use)
"""
from __future__ import annotations

import logging
from typing import Optional

from app.loader import ScenarioAssets
from app.models import ToolResult, WorldState

logger = logging.getLogger(__name__)


class DayController:
    """
    낮 페이즈 컨트롤러

    역할:
    - 사용자 입력 처리
    - 의사결정 로그 추적
    - 턴 실행 (tool_calling -> tool_execute -> output)
    """

    def __init__(self):
        """컨트롤러 초기화"""
        self._decision_log: list[dict] = []

    def execute_turn(
        self,
        user_input: str,
        world_state: WorldState,
        assets: ScenarioAssets,
    ) -> ToolResult:
        """
        낮 턴을 실행합니다 (tool_calling -> tool_execute -> output).

        Args:
            user_input: 사용자 입력 텍스트
            world_state: 현재 월드 상태
            assets: 시나리오 에셋

        Returns:
            ToolResult: tool 실행 결과
        """
        from app.tools import call_tool, TOOLS, _final_values_to_delta

        logger.info(f"[DayController] 턴 시작: user_input={user_input[:50]}...")

        # 1-3. Tool Calling: LLM이 직접 tool과 args 선택 + context 설정
        tool_selection = call_tool(user_input, world_state, assets)
        tool_name = tool_selection["tool_name"]
        tool_args = tool_selection["args"]
        logger.info(f"[DayController] Tool 선택: {tool_name}, args={tool_args}")

        # 의사결정 로그에 기록
        self._decision_log.append({
            "turn": world_state.turn,
            "user_input": user_input,
            "tool_selection": tool_selection,
        })

        # 4. Tool 실행
        tool_fn = TOOLS.get(tool_name)
        if tool_fn:
            result = tool_fn(**tool_args)
        else:
            logger.warning(f"[DayController] 알 수 없는 tool: {tool_name}")
            result = TOOLS["action"](action=user_input)

        # 5. 결과를 ToolResult로 변환
        state_delta = _final_values_to_delta(
            result.get("state_delta", {}),
            world_state
        )

        tool_result = ToolResult(
            event_description=result.get("event_description", []),
            state_delta=state_delta,
        )

        logger.info(f"[DayController] 턴 완료: event={tool_result.event_description}")
        return tool_result

    @property
    def decision_log(self) -> list[dict]:
        """의사결정 로그 반환"""
        return self._decision_log


# ============================================================
# 싱글턴
# ============================================================
_day_controller_instance: Optional[DayController] = None


def get_day_controller() -> DayController:
    """DayController 싱글턴 인스턴스 반환"""
    global _day_controller_instance
    if _day_controller_instance is None:
        _day_controller_instance = DayController()
    return _day_controller_instance


# 하위 호환성을 위한 별칭
ScenarioController = DayController
get_controller = get_day_controller


# ============================================================
# 독립 실행 테스트
# ============================================================
if __name__ == "__main__":
    from pathlib import Path
    from app.loader import ScenarioLoader
    from app.models import WorldState, NPCState

    print("=" * 60)
    print("DAY CONTROLLER 테스트")
    print("=" * 60)

    # 에셋 로드
    base_path = Path(__file__).parent.parent / "scenarios"
    loader = ScenarioLoader(base_path)
    scenarios = loader.list_scenarios()

    if not scenarios:
        print("시나리오가 없습니다!")
        exit(1)

    assets = loader.load(scenarios[0])
    print(f"\n[1] 시나리오 로드됨: {assets.scenario.get('title')}")

    # 테스트용 월드 상태
    world = WorldState(
        turn=1,
        npcs={
            "button_mother": NPCState(npc_id="button_mother", trust=3, fear=0, suspicion=4),
            "button_father": NPCState(npc_id="button_father", trust=2, fear=0, suspicion=5),
            "button_daughter": NPCState(npc_id="button_daughter", trust=3, fear=0, suspicion=3),
        },
        inventory=[],
        vars={"humanity": 10, "total_suspicion": 0}
    )
    print(f"\n[2] 월드 상태 생성: turn={world.turn}, npcs={list(world.npcs.keys())}")

    # 컨트롤러 생성
    controller = get_day_controller()
    print(f"[3] DayController 생성 완료")

    # 테스트 케이스
    test_cases = [
        "엄마에게 단추가 뭐냐고 물어본다",
        "부엌을 둘러본다",
    ]

    print(f"\n[4] execute_turn 테스트 ({len(test_cases)}개):")
    print("-" * 60)

    for text in test_cases:
        print(f"\n  입력: \"{text}\"")
        result = controller.execute_turn(text, world, assets)
        print(f"    사건: {result.event_description}")
        print(f"    델타: {result.state_delta}")

    print("\n" + "=" * 60)
    print("DAY CONTROLLER 테스트 완료")
    print("=" * 60)