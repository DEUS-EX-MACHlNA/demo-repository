/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/pydantic/_internal/_config.py:383: UserWarning: Valid config keys have changed in V2:
* 'orm_mode' has been renamed to 'from_attributes'
  warnings.warn(message, UserWarning)
INFO:     Will watch for changes in these directories: ['/Users/juhpark/Documents/maratang/demo-repository']
INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)
INFO:     Started reloader process [51686] using StatReload
/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/pydantic/_internal/_config.py:383: UserWarning: Valid config keys have changed in V2:
* 'orm_mode' has been renamed to 'from_attributes'
  warnings.warn(message, UserWarning)
INFO:     Started server process [51803]
INFO:     Waiting for application startup.
2026-02-06 13:51:18,547 - app.main - INFO - Starting scenario server...
2026-02-06 13:51:18,547 - app.main - INFO - Scenarios path: /Users/juhpark/Documents/maratang/demo-repository/scenarios
2026-02-06 13:51:18,547 - app.main - INFO - Available scenarios: ['coraline', 'culprit_ai', 'zzapraline']
INFO:     Application startup complete.
INFO:     115.95.186.2:0 - "POST /api/v1/game/2/step HTTP/1.1" 500 Internal Server Error
ERROR:    Exception in ASGI application
Traceback (most recent call last):
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/uvicorn/protocols/http/h11_impl.py", line 428, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/uvicorn/middleware/proxy_headers.py", line 78, in __call__
    return await self.app(scope, receive, send)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/fastapi/applications.py", line 1138, in __call__
    await super().__call__(scope, receive, send)
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/starlette/applications.py", line 107, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 63, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/fastapi/middleware/asyncexitstack.py", line 18, in __call__
    await self.app(scope, receive, send)
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/starlette/routing.py", line 716, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/starlette/routing.py", line 736, in app
    await route.handle(scope, receive, send)
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/starlette/routing.py", line 290, in handle
    await self.app(scope, receive, send)
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/fastapi/routing.py", line 115, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/fastapi/routing.py", line 101, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/fastapi/routing.py", line 355, in app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/fastapi/routing.py", line 245, in run_endpoint_function
    return await run_in_threadpool(dependant.call, **values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/starlette/concurrency.py", line 32, in run_in_threadpool
    return await anyio.to_thread.run_sync(func)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/anyio/to_thread.py", line 63, in run_sync
    return await get_async_backend().run_sync_in_worker_thread(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 2502, in run_sync_in_worker_thread
    return await future
           ^^^^^^^^^^^^
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 986, in run
    result = context.run(func, *args)
             ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/juhpark/Documents/maratang/demo-repository/app/api/routes/v1/game.py", line 63, in step_game
    result = GameService.process_turn(db, game_id, request.dict(), game)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/juhpark/Documents/maratang/demo-repository/app/services/game.py", line 280, in process_turn
    input_dict = cls.execute_turn_with_llm(game, input_data)
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/juhpark/Documents/maratang/demo-repository/app/services/game.py", line 98, in execute_turn_with_llm
    arg2 = WorldInfoSchema(
           ^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/pydantic/main.py", line 250, in __init__
    validated_self = self.__pydantic_validator__.validate_python(data, self_instance=self)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pydantic_core._pydantic_core.ValidationError: 1 validation error for WorldInfoSchema
npcs
  Input should be a valid dictionary or instance of NpcCollectionSchema [type=model_type, input_value=NpcCollectionSchema(npcs=...tart_node', memory={})]), input_type=NpcCollectionSchema]
    For further information visit https://errors.pydantic.dev/2.12/v/model_type
INFO:     115.95.186.2:0 - "GET /docs HTTP/1.1" 200 OK
INFO:     115.95.186.2:0 - "GET /docs HTTP/1.1" 200 OK
INFO:     115.95.186.2:0 - "GET /openapi.json HTTP/1.1" 200 OK
WARNING:  StatReload detected changes in 'app/services/game.py'. Reloading...
INFO:     Shutting down
INFO:     Waiting for application shutdown.
2026-02-06 13:53:58,200 - app.main - INFO - Shutting down scenario server...
INFO:     Application shutdown complete.
INFO:     Finished server process [51803]
/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/pydantic/_internal/_config.py:383: UserWarning: Valid config keys have changed in V2:
* 'orm_mode' has been renamed to 'from_attributes'
  warnings.warn(message, UserWarning)
INFO:     Started server process [52466]
INFO:     Waiting for application startup.
2026-02-06 13:53:58,701 - app.main - INFO - Starting scenario server...
2026-02-06 13:53:58,702 - app.main - INFO - Scenarios path: /Users/juhpark/Documents/maratang/demo-repository/scenarios
2026-02-06 13:53:58,702 - app.main - INFO - Available scenarios: ['coraline', 'culprit_ai', 'zzapraline']
INFO:     Application startup complete.
WARNING:  StatReload detected changes in 'app/services/game.py'. Reloading...
INFO:     Shutting down
INFO:     Waiting for application shutdown.
2026-02-06 13:54:47,191 - app.main - INFO - Shutting down scenario server...
INFO:     Application shutdown complete.
INFO:     Finished server process [52466]
/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/pydantic/_internal/_config.py:383: UserWarning: Valid config keys have changed in V2:
* 'orm_mode' has been renamed to 'from_attributes'
  warnings.warn(message, UserWarning)
INFO:     Started server process [52646]
INFO:     Waiting for application startup.
2026-02-06 13:54:47,623 - app.main - INFO - Starting scenario server...
2026-02-06 13:54:47,623 - app.main - INFO - Scenarios path: /Users/juhpark/Documents/maratang/demo-repository/scenarios
2026-02-06 13:54:47,623 - app.main - INFO - Available scenarios: ['coraline', 'culprit_ai', 'zzapraline']
INFO:     Application startup complete.
DEBUG: LLM received input: string
INFO:     115.95.186.2:0 - "POST /api/v1/game/2/step HTTP/1.1" 500 Internal Server Error
ERROR:    Exception in ASGI application
Traceback (most recent call last):
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/uvicorn/protocols/http/h11_impl.py", line 428, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/uvicorn/middleware/proxy_headers.py", line 78, in __call__
    return await self.app(scope, receive, send)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/fastapi/applications.py", line 1138, in __call__
    await super().__call__(scope, receive, send)
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/starlette/applications.py", line 107, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 63, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/fastapi/middleware/asyncexitstack.py", line 18, in __call__
    await self.app(scope, receive, send)
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/starlette/routing.py", line 716, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/starlette/routing.py", line 736, in app
    await route.handle(scope, receive, send)
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/starlette/routing.py", line 290, in handle
    await self.app(scope, receive, send)
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/fastapi/routing.py", line 115, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/fastapi/routing.py", line 101, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/fastapi/routing.py", line 377, in app
    content = await serialize_response(
              ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/fastapi/routing.py", line 215, in serialize_response
    raise ResponseValidationError(
fastapi.exceptions.ResponseValidationError: 1 validation error:
  {'type': 'dict_type', 'loc': ('response',), 'msg': 'Input should be a valid dictionary', 'input': LLMInputPayload(arg1_user_input=UserInputSchema(chat_input='string', npc_name='string', item_name='string'), arg2_world_info=WorldInfoSchema(player=PlayerSchema(current_node='day1_morning', inventory=['warm_black_tea'], memory={}), npcs=NpcCollectionSchema(npcs=[NpcSchema(npc_id='stepmother', name='새엄마 (엘리노어)', role='메인 감시자 및 집도의', stats={'fear': 80, 'humanity': 0, 'affection': 50}, persona={'taboos': ['무례한 행동', '식사 거부', '비밀 통로 언급'], 'values': ['완벽한 가족', '우아한 질서', '통제'], 'triggers': {'plus': ['순종적인 대답', '예의 바른 말투', '음식 칭찬'], 'minus': ['반항적인 태도', '지하실 접근 시도', '가족의 정체성에 대한 의문']}}, memory={}), NpcSchema(npc_id='stepfather', name='새아빠 (아더)', role='물리적 통제자 및 조력자', stats={'fear': 60, 'humanity': 20, 'affection': 30}, persona={'taboos': ['소란 피우기', '새엄마에 대한 직접적인 비난'], 'values': ['침묵', '규칙 준수', '희미한 죄책감'], 'triggers': {'plus': ['조용한 행동', '신문/잡동사니 가져다주기', '과거의 물건 제시'], 'minus': ['화재 경보 유발', '밤중에 복도 서성거리기', '거짓말']}}, memory={}), NpcSchema(npc_id='brother', name='동생 (루카스)', role='불완전한 조력자', stats={'fear': 40, 'humanity': 50, 'affection': 60}, persona={'taboos': ['혼자 두기', '겁주기', '인형 취급하기'], 'values': ['놀이', '함께하기', '기억의 파편'], 'triggers': {'plus': ['함께 놀아주기', '장난감 선물', '인간적인 감정 공유'], 'minus': ['무시하기', '새엄마에게 일러바치기', '공포 분위기 조성']}}, memory={}), NpcSchema(npc_id='grandmother', name='할머니 (마가렛)', role='세계관 설명자 (Lore)', stats={'fear': 10, 'humanity': 10, 'affection': 20}, persona={'taboos': ['큰 소리', '강제적인 질문'], 'values': ['진실 전달', '마지막 생기'], 'triggers': {'plus': ['생기(인간성) 나눠주기', '낮은 목소리로 경청', '손잡아주기'], 'minus': ['수술 도구 보여주기', '무의미한 소음', '빨리 말하라고 재촉']}}, memory={}), NpcSchema(npc_id='dog_baron', name='강아지 (바론)', role='영적 안내자 및 탐지기', stats={'fear': 0, 'humanity': 100, 'affection': 70}, persona={'taboos': ['폭력', '먹이 뺏기'], 'values': ['충성', '진짜 영혼 식별'], 'triggers': {'plus': ['머리 쓰다듬기', '간식 주기', '진짜 가족사진 보여주기'], 'minus': ['큰 소리로 꾸짖기', '위협적인 물건 들기', '인형화된 냄새(인간성 낮음)']}}, memory={})]), items=ItemCollectionSchema(items=[ItemSchema(item_id='real_family_photo', name='진짜 가족사진', type='lore_clue', description='인형이 되기 전, 가족들의 진짜 얼굴이 담긴 빛바랜 사진.', acquire={'method': 'unlock', 'condition': 'area.hallway.frame_inspected == true or area.garden.doghouse_dug == true'}, use={'actions': [{'label': '과거 상기시키기', 'notes': '새아빠와 동생의 인형 본능에 균열을 내는 핵심 트리거.', 'effects': [{'type': 'stat_add', 'value': 30, 'target': 'npc.target.humanity'}, {'type': 'stat_sub', 'value': 10, 'target': 'npc.target.affection'}], 'action_id': 'show_to_npc', 'allowed_when': "npc.target.id != 'stepmother'"}]}), ItemSchema(item_id='warm_black_tea', name='따뜻한 홍차', type='consumable', description='새엄마가 매일 정성스레 준비하는 차. 달콤하지만 끝맛이 비리다.', acquire={'method': 'start', 'condition': "system.time == 'morning' or system.time == 'evening'"}, use={'actions': [{'label': '차 마시기', 'notes': '기력을 회복시켜주지만 서서히 인간성을 잃게 만드는 함정 아이템.', 'effects': [{'type': 'stat_add', 'value': 20, 'target': 'player.stamina'}, {'type': 'stat_sub', 'value': 5, 'target': 'player.humanity', 'permanent': True}], 'action_id': 'drink', 'allowed_when': 'true'}]}), ItemSchema(item_id='dried_herbs', name='말린 허브 뭉치', type='consumable', description='강한 향을 내는 약초 뭉치. 정신을 맑게 해주는 효능이 있다.', acquire={'method': 'unlock', 'condition': 'area.garden.searched == true or area.basement.shelf_inspected == true'}, use={'actions': [{'label': '향기 들이마시기', 'notes': '인형화를 늦추는 유일한 정화 수단.', 'effects': [{'type': 'stat_add', 'value': 5, 'target': 'player.humanity'}], 'action_id': 'inhale_scent', 'allowed_when': 'player.humanity < 100'}]}), ItemSchema(item_id='dog_treat', name='강아지 간식', type='gift', description='바론이 가장 좋아하는 육포. 주방 찬장에 숨겨져 있었다.', acquire={'method': 'unlock', 'condition': 'area.kitchen.cabinet_searched == true'}, use={'actions': [{'label': '바론에게 주기', 'notes': '호감도 상승 시 바론이 감시자(새엄마/새아빠)의 위치를 소리로 알려줌.', 'effects': [{'type': 'stat_add', 'value': 25, 'target': 'npc.baron.affection'}, {'type': 'trigger_event', 'event_id': 'baron_alert_active'}], 'action_id': 'feed_baron', 'allowed_when': "area.current == 'garden'"}]}), ItemSchema(item_id='industrial_sedative', name='공업용 수면제', type='tool', description='강력한 진정 효과가 있는 액체 약물. 주의가 필요하다.', acquire={'method': 'reward', 'condition': 'area.kitchen.locked_cabinet.unlocked == true'}, use={'actions': [{'label': '음식에 타기', 'notes': '특정 NPC를 3턴간 무력화하여 자유로운 탐색 기회를 확보.', 'effects': [{'type': 'set_state', 'value': 'sleeping', 'target': 'npc.target.status', 'duration': 3}], 'action_id': 'spike_food', 'allowed_when': "system.phase == 'evening_prep'"}]}), ItemSchema(item_id='oil_and_lighter', name='기름병과 라이터', type='quest_item', description='불을 붙일 수 있는 도구 세트. 위험한 상황을 초래할 수 있다.', acquire={'method': 'unlock', 'condition': 'has_item(oil_bottle) and has_item(lighter)'}, use={'actions': [{'label': '방화하기', 'notes': '혼돈의 밤 엔딩 진입을 위한 필수 행동.', 'effects': [{'key': 'house_status', 'type': 'set_env', 'value': 'chaos'}, {'type': 'unlock_ending', 'ending_id': 'chaotic_breakout'}], 'action_id': 'start_fire', 'allowed_when': "area.current == 'living_room' or area.current == 'kitchen'"}]}), ItemSchema(item_id='lubricant_oil', name='윤활유', type='tool', description='기계 마찰을 줄여주는 기름. 삐걱거리는 곳에 효과적이다.', acquire={'method': 'unlock', 'condition': 'area.backyard.storage_searched == true'}, use={'actions': [{'label': '기름칠하기', 'notes': '야간 행동 시 NPC에게 들킬 확률(소음 발생률)을 크게 낮춤.', 'effects': [{'key': 'stealth_bonus', 'type': 'var_add', 'value': 15}], 'action_id': 'apply_to_door', 'allowed_when': 'true'}]}), ItemSchema(item_id='mothers_key', name='엄마의 열쇠', type='key', description='새엄마의 목에 걸려 있던 정교한 열쇠. 개구멍의 자물쇠와 맞는다.', acquire={'method': 'reward', 'condition': "npc.stepmother.status == 'sleeping' or npc.brother.affection == 100"}, use={'actions': [{'label': '탈출구 개방', 'notes': '개구멍을 통해 현실 세계로 돌아가는 문을 여는 최종 아이템.', 'effects': [{'type': 'change_scene', 'target': 'ending_sequence'}], 'action_id': 'unlock_exit', 'allowed_when': "area.current == 'player_room' and target == 'dog_hole'"}]})])), arg3_logic_context=LogicContextSchema(meta={'title': '인형의 집 (Puppet Home)', 'genre': 'AI 기반 자유 서술 심리 스릴러', 'tone': '기괴하고 상냥한, 서서히 조여오는 압박감', 'pov': '2nd'}, state={'turn': 1, 'vars': {'day': 1, 'humanity': 100, 'house_on_fire': 0, 'suspicion_level': 0, 'trust': 5, 'clue_count': 1}, 'flags': {'act': 1, 'ending': None, 'truth_revealed': False, 'basement_unlocked': False}, 'active_events': []}, rules={'global_rules': ["플레이어의 모든 자유 서술은 현재 '상태(결박/위치)'와 '현실성' 검증을 거친 후 판정", "NPC는 '밤의 대화'를 통해 플레이어의 낮 행동을 공유하고 다음 날의 태도를 결정", '인간성(Humanity)이 0이 되는 즉시 모든 행동 우선권을 상실하고 엔딩 시퀀스로 강제 진입', "엔진이 확정한 '저택의 비밀' 외에 플레이어가 임의로 가공의 탈출구를 생성하는 것 금지"], 'victory_conditions': ["ending == 'stealth_exit'", "ending == 'chaotic_breakout'", "ending == 'sibling_sacrifice'"], 'failure_conditions': ["ending == 'unfinished_doll'", "ending == 'eternal_dinner'"], 'endings': [{'name': '완벽한 기만 (The Stealth Exit)', 'condition': "has_item(industrial_sedative) and has_item(mothers_key) and npc.stepmother.status == 'sleeping' and system.turn >= 40", 'ending_id': 'stealth_exit', 'epilogue_prompt': '조용하고 서늘하게, 뒤도 돌아보지 않고 안개 속으로 사라지는 주인공을 묘사하라.', 'on_enter_events': [{'key': 'ending', 'type': 'flag_set', 'value': 'stealth_exit'}]}, {'name': '혼돈의 밤 (The Chaotic Breakout)', 'condition': 'has_item(oil_and_lighter) and vars.house_on_fire == true and npc.grandmother.humanity >= 50', 'ending_id': 'chaotic_breakout', 'epilogue_prompt': '타오르는 저택의 불길과 인형들의 비명, 파괴를 통한 자유의 희열을 묘사하라.', 'on_enter_events': [{'key': 'ending', 'type': 'flag_set', 'value': 'chaotic_breakout'}]}, {'name': "조력자의 희생 (The Sibling's Help)", 'condition': 'npc.brother.affection >= 90 and npc.brother.humanity >= 70 and vars.day == 5', 'ending_id': 'sibling_sacrifice', 'epilogue_prompt': '동생의 슬픈 미소와 주인공의 죄책감, 눈물 젖은 탈출을 감성적으로 묘사하라.', 'on_enter_events': [{'key': 'ending', 'type': 'flag_set', 'value': 'sibling_sacrifice'}]}, {'name': '불완전한 박제 (The Unfinished Doll)', 'condition': 'vars.humanity <= 0', 'ending_id': 'unfinished_doll', 'epilogue_prompt': '자아를 잃고 눈동자가 단추로 변해가는 과정과 새엄마의 기쁜 바느질 소리를 묘사하라.', 'on_enter_events': [{'key': 'ending', 'type': 'flag_set', 'value': 'unfinished_doll'}]}, {'name': '영원한 식사 시간 (The Eternal Dinner)', 'condition': 'system.turn == turn_limit and flags.ending == null', 'ending_id': 'eternal_dinner', 'epilogue_prompt': '맛이 느껴지지 않는 고기를 씹으며 가짜 가족들과 영원히 웃고 있는 비극을 묘사하라.', 'on_enter_events': [{'key': 'ending', 'type': 'flag_set', 'value': 'eternal_dinner'}]}]}), arg4_model_config=ModelConfigSchema(model_name='gpt-4-turbo', temperature=0.7, extra_settings={}))}

  File "/Users/juhpark/Documents/maratang/demo-repository/app/api/routes/v1/game.py", line 56, in step_game
    POST /api/v1/game/{game_id}/step
WARNING:  StatReload detected changes in 'app/services/game.py'. Reloading...
INFO:     Shutting down
INFO:     Waiting for application shutdown.
2026-02-06 13:55:16,020 - app.main - INFO - Shutting down scenario server...
INFO:     Application shutdown complete.
INFO:     Finished server process [52646]
/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/pydantic/_internal/_config.py:383: UserWarning: Valid config keys have changed in V2:
* 'orm_mode' has been renamed to 'from_attributes'
  warnings.warn(message, UserWarning)
INFO:     Started server process [52752]
INFO:     Waiting for application startup.
2026-02-06 13:55:16,459 - app.main - INFO - Starting scenario server...
2026-02-06 13:55:16,459 - app.main - INFO - Scenarios path: /Users/juhpark/Documents/maratang/demo-repository/scenarios
2026-02-06 13:55:16,460 - app.main - INFO - Available scenarios: ['coraline', 'culprit_ai', 'zzapraline']
INFO:     Application startup complete.
INFO:     115.95.186.2:0 - "POST /api/v1/game/2/step HTTP/1.1" 500 Internal Server Error
ERROR:    Exception in ASGI application
Traceback (most recent call last):
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/uvicorn/protocols/http/h11_impl.py", line 428, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/uvicorn/middleware/proxy_headers.py", line 78, in __call__
    return await self.app(scope, receive, send)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/fastapi/applications.py", line 1138, in __call__
    await super().__call__(scope, receive, send)
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/starlette/applications.py", line 107, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 63, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/fastapi/middleware/asyncexitstack.py", line 18, in __call__
    await self.app(scope, receive, send)
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/starlette/routing.py", line 716, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/starlette/routing.py", line 736, in app
    await route.handle(scope, receive, send)
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/starlette/routing.py", line 290, in handle
    await self.app(scope, receive, send)
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/fastapi/routing.py", line 115, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/fastapi/routing.py", line 101, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/fastapi/routing.py", line 355, in app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/fastapi/routing.py", line 245, in run_endpoint_function
    return await run_in_threadpool(dependant.call, **values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/starlette/concurrency.py", line 32, in run_in_threadpool
    return await anyio.to_thread.run_sync(func)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/anyio/to_thread.py", line 63, in run_sync
    return await get_async_backend().run_sync_in_worker_thread(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 2502, in run_sync_in_worker_thread
    return await future
           ^^^^^^^^^^^^
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 986, in run
    result = context.run(func, *args)
             ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/juhpark/Documents/maratang/demo-repository/app/api/routes/v1/game.py", line 63, in step_game
    result = GameService.process_turn(db, game_id, request.dict(), game)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/juhpark/Documents/maratang/demo-repository/app/services/game.py", line 280, in process_turn
    input_dict = cls.execute_turn_with_llm(game, input_data)
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/juhpark/Documents/maratang/demo-repository/app/services/game.py", line 98, in execute_turn_with_llm
    arg2 = WorldInfoSchema(
           ^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/pydantic/main.py", line 250, in __init__
    validated_self = self.__pydantic_validator__.validate_python(data, self_instance=self)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pydantic_core._pydantic_core.ValidationError: 1 validation error for WorldInfoSchema
npcs
  Input should be a valid dictionary or instance of NpcCollectionSchema [type=model_type, input_value=NpcCollectionSchema(npcs=...tart_node', memory={})]), input_type=NpcCollectionSchema]
    For further information visit https://errors.pydantic.dev/2.12/v/model_type
INFO:     115.95.186.2:0 - "POST /api/v1/game/2/step HTTP/1.1" 500 Internal Server Error
ERROR:    Exception in ASGI application
Traceback (most recent call last):
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/uvicorn/protocols/http/h11_impl.py", line 428, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/uvicorn/middleware/proxy_headers.py", line 78, in __call__
    return await self.app(scope, receive, send)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/fastapi/applications.py", line 1138, in __call__
    await super().__call__(scope, receive, send)
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/starlette/applications.py", line 107, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 63, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/fastapi/middleware/asyncexitstack.py", line 18, in __call__
    await self.app(scope, receive, send)
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/starlette/routing.py", line 716, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/starlette/routing.py", line 736, in app
    await route.handle(scope, receive, send)
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/starlette/routing.py", line 290, in handle
    await self.app(scope, receive, send)
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/fastapi/routing.py", line 115, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/fastapi/routing.py", line 101, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/fastapi/routing.py", line 355, in app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/fastapi/routing.py", line 245, in run_endpoint_function
    return await run_in_threadpool(dependant.call, **values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/starlette/concurrency.py", line 32, in run_in_threadpool
    return await anyio.to_thread.run_sync(func)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/anyio/to_thread.py", line 63, in run_sync
    return await get_async_backend().run_sync_in_worker_thread(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 2502, in run_sync_in_worker_thread
    return await future
           ^^^^^^^^^^^^
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 986, in run
    result = context.run(func, *args)
             ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/juhpark/Documents/maratang/demo-repository/app/api/routes/v1/game.py", line 63, in step_game
    result = GameService.process_turn(db, game_id, request.dict(), game)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/juhpark/Documents/maratang/demo-repository/app/services/game.py", line 280, in process_turn
    input_dict = cls.execute_turn_with_llm(game, input_data)
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/juhpark/Documents/maratang/demo-repository/app/services/game.py", line 98, in execute_turn_with_llm
    arg2 = WorldInfoSchema(
           ^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/pydantic/main.py", line 250, in __init__
    validated_self = self.__pydantic_validator__.validate_python(data, self_instance=self)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pydantic_core._pydantic_core.ValidationError: 1 validation error for WorldInfoSchema
npcs
  Input should be a valid dictionary or instance of NpcCollectionSchema [type=model_type, input_value=NpcCollectionSchema(npcs=...tart_node', memory={})]), input_type=NpcCollectionSchema]
    For further information visit https://errors.pydantic.dev/2.12/v/model_type
WARNING:  StatReload detected changes in 'app/schemas/llm_payload_input.py'. Reloading...
INFO:     Shutting down
INFO:     Waiting for application shutdown.
2026-02-06 13:55:48,747 - app.main - INFO - Shutting down scenario server...
INFO:     Application shutdown complete.
INFO:     Finished server process [52752]
/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/pydantic/_internal/_config.py:383: UserWarning: Valid config keys have changed in V2:
* 'orm_mode' has been renamed to 'from_attributes'
  warnings.warn(message, UserWarning)
INFO:     Started server process [52876]
INFO:     Waiting for application startup.
2026-02-06 13:55:49,162 - app.main - INFO - Starting scenario server...
2026-02-06 13:55:49,162 - app.main - INFO - Scenarios path: /Users/juhpark/Documents/maratang/demo-repository/scenarios
2026-02-06 13:55:49,162 - app.main - INFO - Available scenarios: ['coraline', 'culprit_ai', 'zzapraline']
INFO:     Application startup complete.
WARNING:  StatReload detected changes in 'app/schemas/llm_payload_input.py'. Reloading...
INFO:     Shutting down
INFO:     Waiting for application shutdown.
2026-02-06 13:56:25,675 - app.main - INFO - Shutting down scenario server...
INFO:     Application shutdown complete.
INFO:     Finished server process [52876]
/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/pydantic/_internal/_config.py:383: UserWarning: Valid config keys have changed in V2:
* 'orm_mode' has been renamed to 'from_attributes'
  warnings.warn(message, UserWarning)
INFO:     Started server process [53008]
INFO:     Waiting for application startup.
2026-02-06 13:56:26,117 - app.main - INFO - Starting scenario server...
2026-02-06 13:56:26,117 - app.main - INFO - Scenarios path: /Users/juhpark/Documents/maratang/demo-repository/scenarios
2026-02-06 13:56:26,117 - app.main - INFO - Available scenarios: ['coraline', 'culprit_ai', 'zzapraline']
INFO:     Application startup complete.
INFO:     115.95.186.2:0 - "GET /docs HTTP/1.1" 200 OK
INFO:     115.95.186.2:0 - "GET /openapi.json HTTP/1.1" 200 OK
DEBUG: LLM received input: string
INFO:     115.95.186.2:0 - "POST /api/v1/game/2/step HTTP/1.1" 500 Internal Server Error
ERROR:    Exception in ASGI application
Traceback (most recent call last):
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/uvicorn/protocols/http/h11_impl.py", line 428, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/uvicorn/middleware/proxy_headers.py", line 78, in __call__
    return await self.app(scope, receive, send)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/fastapi/applications.py", line 1138, in __call__
    await super().__call__(scope, receive, send)
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/starlette/applications.py", line 107, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 63, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/fastapi/middleware/asyncexitstack.py", line 18, in __call__
    await self.app(scope, receive, send)
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/starlette/routing.py", line 716, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/starlette/routing.py", line 736, in app
    await route.handle(scope, receive, send)
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/starlette/routing.py", line 290, in handle
    await self.app(scope, receive, send)
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/fastapi/routing.py", line 115, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/fastapi/routing.py", line 101, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/fastapi/routing.py", line 377, in app
    content = await serialize_response(
              ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/fastapi/routing.py", line 215, in serialize_response
    raise ResponseValidationError(
fastapi.exceptions.ResponseValidationError: 1 validation error:
  {'type': 'dict_type', 'loc': ('response',), 'msg': 'Input should be a valid dictionary', 'input': LLMInputPayload(arg1_user_input=UserInputSchema(chat_input='string', npc_name='string', item_name='string'), arg2_world_info=WorldInfoSchema(player=PlayerSchema(current_node='day1_morning', inventory=['warm_black_tea', ''], memo=[], memory={}), npcs=NpcCollectionSchema(npcs=[NpcSchema(npc_id='stepmother', name='새엄마 (엘리노어)', role='메인 감시자 및 집도의', user_id=None, status=<NPCStatus.ALIVE: 'alive'>, stats={'fear': 80, 'humanity': 0, 'affection': 50}, persona={'taboos': ['무례한 행동', '식사 거부', '비밀 통로 언급'], 'values': ['완벽한 가족', '우아한 질서', '통제'], 'triggers': {'plus': ['순종적인 대답', '예의 바른 말투', '음식 칭찬'], 'minus': ['반항적인 태도', '지하실 접근 시도', '가족의 정체성에 대한 의문']}}, current_node='start_node', memory={}), NpcSchema(npc_id='stepfather', name='새아빠 (아더)', role='물리적 통제자 및 조력자', user_id=None, status=<NPCStatus.ALIVE: 'alive'>, stats={'fear': 60, 'humanity': 20, 'affection': 30}, persona={'taboos': ['소란 피우기', '새엄마에 대한 직접적인 비난'], 'values': ['침묵', '규칙 준수', '희미한 죄책감'], 'triggers': {'plus': ['조용한 행동', '신문/잡동사니 가져다주기', '과거의 물건 제시'], 'minus': ['화재 경보 유발', '밤중에 복도 서성거리기', '거짓말']}}, current_node='start_node', memory={}), NpcSchema(npc_id='brother', name='동생 (루카스)', role='불완전한 조력자', user_id=None, status=<NPCStatus.ALIVE: 'alive'>, stats={'fear': 40, 'humanity': 50, 'affection': 60}, persona={'taboos': ['혼자 두기', '겁주기', '인형 취급하기'], 'values': ['놀이', '함께하기', '기억의 파편'], 'triggers': {'plus': ['함께 놀아주기', '장난감 선물', '인간적인 감정 공유'], 'minus': ['무시하기', '새엄마에게 일러바치기', '공포 분위기 조성']}}, current_node='start_node', memory={}), NpcSchema(npc_id='grandmother', name='할머니 (마가렛)', role='세계관 설명자 (Lore)', user_id=None, status=<NPCStatus.ALIVE: 'alive'>, stats={'fear': 10, 'humanity': 10, 'affection': 20}, persona={'taboos': ['큰 소리', '강제적인 질문'], 'values': ['진실 전달', '마지막 생기'], 'triggers': {'plus': ['생기(인간성) 나눠주기', '낮은 목소리로 경청', '손잡아주기'], 'minus': ['수술 도구 보여주기', '무의미한 소음', '빨리 말하라고 재촉']}}, current_node='start_node', memory={}), NpcSchema(npc_id='dog_baron', name='강아지 (바론)', role='영적 안내자 및 탐지기', user_id=None, status=<NPCStatus.ALIVE: 'alive'>, stats={'fear': 0, 'humanity': 100, 'affection': 70}, persona={'taboos': ['폭력', '먹이 뺏기'], 'values': ['충성', '진짜 영혼 식별'], 'triggers': {'plus': ['머리 쓰다듬기', '간식 주기', '진짜 가족사진 보여주기'], 'minus': ['큰 소리로 꾸짖기', '위협적인 물건 들기', '인형화된 냄새(인간성 낮음)']}}, current_node='start_node', memory={})]), items=ItemCollectionSchema(items=[ItemSchema(item_id='real_family_photo', name='진짜 가족사진', type='lore_clue', description='인형이 되기 전, 가족들의 진짜 얼굴이 담긴 빛바랜 사진.', acquire={'method': 'unlock', 'condition': 'area.hallway.frame_inspected == true or area.garden.doghouse_dug == true'}, use={'actions': [{'label': '과거 상기시키기', 'notes': '새아빠와 동생의 인형 본능에 균열을 내는 핵심 트리거.', 'effects': [{'type': 'stat_add', 'value': 30, 'target': 'npc.target.humanity'}, {'type': 'stat_sub', 'value': 10, 'target': 'npc.target.affection'}], 'action_id': 'show_to_npc', 'allowed_when': "npc.target.id != 'stepmother'"}]}), ItemSchema(item_id='warm_black_tea', name='따뜻한 홍차', type='consumable', description='새엄마가 매일 정성스레 준비하는 차. 달콤하지만 끝맛이 비리다.', acquire={'method': 'start', 'condition': "system.time == 'morning' or system.time == 'evening'"}, use={'actions': [{'label': '차 마시기', 'notes': '기력을 회복시켜주지만 서서히 인간성을 잃게 만드는 함정 아이템.', 'effects': [{'type': 'stat_add', 'value': 20, 'target': 'player.stamina'}, {'type': 'stat_sub', 'value': 5, 'target': 'player.humanity', 'permanent': True}], 'action_id': 'drink', 'allowed_when': 'true'}]}), ItemSchema(item_id='dried_herbs', name='말린 허브 뭉치', type='consumable', description='강한 향을 내는 약초 뭉치. 정신을 맑게 해주는 효능이 있다.', acquire={'method': 'unlock', 'condition': 'area.garden.searched == true or area.basement.shelf_inspected == true'}, use={'actions': [{'label': '향기 들이마시기', 'notes': '인형화를 늦추는 유일한 정화 수단.', 'effects': [{'type': 'stat_add', 'value': 5, 'target': 'player.humanity'}], 'action_id': 'inhale_scent', 'allowed_when': 'player.humanity < 100'}]}), ItemSchema(item_id='dog_treat', name='강아지 간식', type='gift', description='바론이 가장 좋아하는 육포. 주방 찬장에 숨겨져 있었다.', acquire={'method': 'unlock', 'condition': 'area.kitchen.cabinet_searched == true'}, use={'actions': [{'label': '바론에게 주기', 'notes': '호감도 상승 시 바론이 감시자(새엄마/새아빠)의 위치를 소리로 알려줌.', 'effects': [{'type': 'stat_add', 'value': 25, 'target': 'npc.baron.affection'}, {'type': 'trigger_event', 'event_id': 'baron_alert_active'}], 'action_id': 'feed_baron', 'allowed_when': "area.current == 'garden'"}]}), ItemSchema(item_id='industrial_sedative', name='공업용 수면제', type='tool', description='강력한 진정 효과가 있는 액체 약물. 주의가 필요하다.', acquire={'method': 'reward', 'condition': 'area.kitchen.locked_cabinet.unlocked == true'}, use={'actions': [{'label': '음식에 타기', 'notes': '특정 NPC를 3턴간 무력화하여 자유로운 탐색 기회를 확보.', 'effects': [{'type': 'set_state', 'value': 'sleeping', 'target': 'npc.target.status', 'duration': 3}], 'action_id': 'spike_food', 'allowed_when': "system.phase == 'evening_prep'"}]}), ItemSchema(item_id='oil_and_lighter', name='기름병과 라이터', type='quest_item', description='불을 붙일 수 있는 도구 세트. 위험한 상황을 초래할 수 있다.', acquire={'method': 'unlock', 'condition': 'has_item(oil_bottle) and has_item(lighter)'}, use={'actions': [{'label': '방화하기', 'notes': '혼돈의 밤 엔딩 진입을 위한 필수 행동.', 'effects': [{'key': 'house_status', 'type': 'set_env', 'value': 'chaos'}, {'type': 'unlock_ending', 'ending_id': 'chaotic_breakout'}], 'action_id': 'start_fire', 'allowed_when': "area.current == 'living_room' or area.current == 'kitchen'"}]}), ItemSchema(item_id='lubricant_oil', name='윤활유', type='tool', description='기계 마찰을 줄여주는 기름. 삐걱거리는 곳에 효과적이다.', acquire={'method': 'unlock', 'condition': 'area.backyard.storage_searched == true'}, use={'actions': [{'label': '기름칠하기', 'notes': '야간 행동 시 NPC에게 들킬 확률(소음 발생률)을 크게 낮춤.', 'effects': [{'key': 'stealth_bonus', 'type': 'var_add', 'value': 15}], 'action_id': 'apply_to_door', 'allowed_when': 'true'}]}), ItemSchema(item_id='mothers_key', name='엄마의 열쇠', type='key', description='새엄마의 목에 걸려 있던 정교한 열쇠. 개구멍의 자물쇠와 맞는다.', acquire={'method': 'reward', 'condition': "npc.stepmother.status == 'sleeping' or npc.brother.affection == 100"}, use={'actions': [{'label': '탈출구 개방', 'notes': '개구멍을 통해 현실 세계로 돌아가는 문을 여는 최종 아이템.', 'effects': [{'type': 'change_scene', 'target': 'ending_sequence'}], 'action_id': 'unlock_exit', 'allowed_when': "area.current == 'player_room' and target == 'dog_hole'"}]})])), arg3_logic_context=LogicContextSchema(meta={'title': '인형의 집 (Puppet Home)', 'genre': 'AI 기반 자유 서술 심리 스릴러', 'tone': '기괴하고 상냥한, 서서히 조여오는 압박감', 'pov': '2nd'}, state={'turn': 1, 'vars': {'day': 1, 'humanity': 100, 'house_on_fire': 0, 'suspicion_level': 0, 'trust': 5, 'clue_count': 1}, 'flags': {'act': 1, 'ending': None, 'truth_revealed': False, 'basement_unlocked': False}, 'active_events': []}, rules={'global_rules': ["플레이어의 모든 자유 서술은 현재 '상태(결박/위치)'와 '현실성' 검증을 거친 후 판정", "NPC는 '밤의 대화'를 통해 플레이어의 낮 행동을 공유하고 다음 날의 태도를 결정", '인간성(Humanity)이 0이 되는 즉시 모든 행동 우선권을 상실하고 엔딩 시퀀스로 강제 진입', "엔진이 확정한 '저택의 비밀' 외에 플레이어가 임의로 가공의 탈출구를 생성하는 것 금지"], 'victory_conditions': ["ending == 'stealth_exit'", "ending == 'chaotic_breakout'", "ending == 'sibling_sacrifice'"], 'failure_conditions': ["ending == 'unfinished_doll'", "ending == 'eternal_dinner'"], 'endings': [{'name': '완벽한 기만 (The Stealth Exit)', 'condition': "has_item(industrial_sedative) and has_item(mothers_key) and npc.stepmother.status == 'sleeping' and system.turn >= 40", 'ending_id': 'stealth_exit', 'epilogue_prompt': '조용하고 서늘하게, 뒤도 돌아보지 않고 안개 속으로 사라지는 주인공을 묘사하라.', 'on_enter_events': [{'key': 'ending', 'type': 'flag_set', 'value': 'stealth_exit'}]}, {'name': '혼돈의 밤 (The Chaotic Breakout)', 'condition': 'has_item(oil_and_lighter) and vars.house_on_fire == true and npc.grandmother.humanity >= 50', 'ending_id': 'chaotic_breakout', 'epilogue_prompt': '타오르는 저택의 불길과 인형들의 비명, 파괴를 통한 자유의 희열을 묘사하라.', 'on_enter_events': [{'key': 'ending', 'type': 'flag_set', 'value': 'chaotic_breakout'}]}, {'name': "조력자의 희생 (The Sibling's Help)", 'condition': 'npc.brother.affection >= 90 and npc.brother.humanity >= 70 and vars.day == 5', 'ending_id': 'sibling_sacrifice', 'epilogue_prompt': '동생의 슬픈 미소와 주인공의 죄책감, 눈물 젖은 탈출을 감성적으로 묘사하라.', 'on_enter_events': [{'key': 'ending', 'type': 'flag_set', 'value': 'sibling_sacrifice'}]}, {'name': '불완전한 박제 (The Unfinished Doll)', 'condition': 'vars.humanity <= 0', 'ending_id': 'unfinished_doll', 'epilogue_prompt': '자아를 잃고 눈동자가 단추로 변해가는 과정과 새엄마의 기쁜 바느질 소리를 묘사하라.', 'on_enter_events': [{'key': 'ending', 'type': 'flag_set', 'value': 'unfinished_doll'}]}, {'name': '영원한 식사 시간 (The Eternal Dinner)', 'condition': 'system.turn == turn_limit and flags.ending == null', 'ending_id': 'eternal_dinner', 'epilogue_prompt': '맛이 느껴지지 않는 고기를 씹으며 가짜 가족들과 영원히 웃고 있는 비극을 묘사하라.', 'on_enter_events': [{'key': 'ending', 'type': 'flag_set', 'value': 'eternal_dinner'}]}]}), arg4_model_config=ModelConfigSchema(model_name='gpt-4-turbo', temperature=0.7, extra_settings={}))}

  File "/Users/juhpark/Documents/maratang/demo-repository/app/api/routes/v1/game.py", line 56, in step_game
    POST /api/v1/game/{game_id}/step
WARNING:  StatReload detected changes in 'app/services/game.py'. Reloading...
INFO:     Shutting down
INFO:     Waiting for application shutdown.
2026-02-06 13:57:19,564 - app.main - INFO - Shutting down scenario server...
INFO:     Application shutdown complete.
INFO:     Finished server process [53008]
/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/pydantic/_internal/_config.py:383: UserWarning: Valid config keys have changed in V2:
* 'orm_mode' has been renamed to 'from_attributes'
  warnings.warn(message, UserWarning)
INFO:     Started server process [53353]
INFO:     Waiting for application startup.
2026-02-06 13:57:19,971 - app.main - INFO - Starting scenario server...
2026-02-06 13:57:19,971 - app.main - INFO - Scenarios path: /Users/juhpark/Documents/maratang/demo-repository/scenarios
2026-02-06 13:57:19,971 - app.main - INFO - Available scenarios: ['coraline', 'culprit_ai', 'zzapraline']
INFO:     Application startup complete.
WARNING:  StatReload detected changes in 'app/services/game.py'. Reloading...
INFO:     Shutting down
INFO:     Waiting for application shutdown.
2026-02-06 13:57:39,085 - app.main - INFO - Shutting down scenario server...
INFO:     Application shutdown complete.
INFO:     Finished server process [53353]
/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/pydantic/_internal/_config.py:383: UserWarning: Valid config keys have changed in V2:
* 'orm_mode' has been renamed to 'from_attributes'
  warnings.warn(message, UserWarning)
INFO:     Started server process [53435]
INFO:     Waiting for application startup.
2026-02-06 13:57:39,522 - app.main - INFO - Starting scenario server...
2026-02-06 13:57:39,522 - app.main - INFO - Scenarios path: /Users/juhpark/Documents/maratang/demo-repository/scenarios
2026-02-06 13:57:39,522 - app.main - INFO - Available scenarios: ['coraline', 'culprit_ai', 'zzapraline']
INFO:     Application startup complete.
WARNING:  StatReload detected changes in 'app/services/game.py'. Reloading...
INFO:     Shutting down
INFO:     Waiting for application shutdown.
2026-02-06 13:57:41,138 - app.main - INFO - Shutting down scenario server...
INFO:     Application shutdown complete.
INFO:     Finished server process [53435]
/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/pydantic/_internal/_config.py:383: UserWarning: Valid config keys have changed in V2:
* 'orm_mode' has been renamed to 'from_attributes'
  warnings.warn(message, UserWarning)
INFO:     Started server process [53447]
INFO:     Waiting for application startup.
2026-02-06 13:57:41,564 - app.main - INFO - Starting scenario server...
2026-02-06 13:57:41,564 - app.main - INFO - Scenarios path: /Users/juhpark/Documents/maratang/demo-repository/scenarios
2026-02-06 13:57:41,564 - app.main - INFO - Available scenarios: ['coraline', 'culprit_ai', 'zzapraline']
INFO:     Application startup complete.
DEBUG: LLM received input: string
INFO:     115.95.186.2:0 - "POST /api/v1/game/2/step HTTP/1.1" 500 Internal Server Error
ERROR:    Exception in ASGI application
Traceback (most recent call last):
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/uvicorn/protocols/http/h11_impl.py", line 428, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/uvicorn/middleware/proxy_headers.py", line 78, in __call__
    return await self.app(scope, receive, send)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/fastapi/applications.py", line 1138, in __call__
    await super().__call__(scope, receive, send)
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/starlette/applications.py", line 107, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 63, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/fastapi/middleware/asyncexitstack.py", line 18, in __call__
    await self.app(scope, receive, send)
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/starlette/routing.py", line 716, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/starlette/routing.py", line 736, in app
    await route.handle(scope, receive, send)
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/starlette/routing.py", line 290, in handle
    await self.app(scope, receive, send)
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/fastapi/routing.py", line 115, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/fastapi/routing.py", line 101, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/fastapi/routing.py", line 377, in app
    content = await serialize_response(
              ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/fastapi/routing.py", line 215, in serialize_response
    raise ResponseValidationError(
fastapi.exceptions.ResponseValidationError: 1 validation error:
  {'type': 'dict_type', 'loc': ('response',), 'msg': 'Input should be a valid dictionary', 'input': LLMInputPayload(arg1_user_input=UserInputSchema(chat_input='string', npc_name='string', item_name='string'), arg2_world_info=WorldInfoSchema(player=PlayerSchema(current_node='day1_morning', inventory=['warm_black_tea', ''], memo=[], memory={}), npcs=NpcCollectionSchema(npcs=[NpcSchema(npc_id='stepmother', name='새엄마 (엘리노어)', role='메인 감시자 및 집도의', user_id=None, status=<NPCStatus.ALIVE: 'alive'>, stats={'fear': 80, 'humanity': 0, 'affection': 50}, persona={'taboos': ['무례한 행동', '식사 거부', '비밀 통로 언급'], 'values': ['완벽한 가족', '우아한 질서', '통제'], 'triggers': {'plus': ['순종적인 대답', '예의 바른 말투', '음식 칭찬'], 'minus': ['반항적인 태도', '지하실 접근 시도', '가족의 정체성에 대한 의문']}}, current_node='start_node', memory={}), NpcSchema(npc_id='stepfather', name='새아빠 (아더)', role='물리적 통제자 및 조력자', user_id=None, status=<NPCStatus.ALIVE: 'alive'>, stats={'fear': 60, 'humanity': 20, 'affection': 30}, persona={'taboos': ['소란 피우기', '새엄마에 대한 직접적인 비난'], 'values': ['침묵', '규칙 준수', '희미한 죄책감'], 'triggers': {'plus': ['조용한 행동', '신문/잡동사니 가져다주기', '과거의 물건 제시'], 'minus': ['화재 경보 유발', '밤중에 복도 서성거리기', '거짓말']}}, current_node='start_node', memory={}), NpcSchema(npc_id='brother', name='동생 (루카스)', role='불완전한 조력자', user_id=None, status=<NPCStatus.ALIVE: 'alive'>, stats={'fear': 40, 'humanity': 50, 'affection': 60}, persona={'taboos': ['혼자 두기', '겁주기', '인형 취급하기'], 'values': ['놀이', '함께하기', '기억의 파편'], 'triggers': {'plus': ['함께 놀아주기', '장난감 선물', '인간적인 감정 공유'], 'minus': ['무시하기', '새엄마에게 일러바치기', '공포 분위기 조성']}}, current_node='start_node', memory={}), NpcSchema(npc_id='grandmother', name='할머니 (마가렛)', role='세계관 설명자 (Lore)', user_id=None, status=<NPCStatus.ALIVE: 'alive'>, stats={'fear': 10, 'humanity': 10, 'affection': 20}, persona={'taboos': ['큰 소리', '강제적인 질문'], 'values': ['진실 전달', '마지막 생기'], 'triggers': {'plus': ['생기(인간성) 나눠주기', '낮은 목소리로 경청', '손잡아주기'], 'minus': ['수술 도구 보여주기', '무의미한 소음', '빨리 말하라고 재촉']}}, current_node='start_node', memory={}), NpcSchema(npc_id='dog_baron', name='강아지 (바론)', role='영적 안내자 및 탐지기', user_id=None, status=<NPCStatus.ALIVE: 'alive'>, stats={'fear': 0, 'humanity': 100, 'affection': 70}, persona={'taboos': ['폭력', '먹이 뺏기'], 'values': ['충성', '진짜 영혼 식별'], 'triggers': {'plus': ['머리 쓰다듬기', '간식 주기', '진짜 가족사진 보여주기'], 'minus': ['큰 소리로 꾸짖기', '위협적인 물건 들기', '인형화된 냄새(인간성 낮음)']}}, current_node='start_node', memory={})]), items=ItemCollectionSchema(items=[ItemSchema(item_id='real_family_photo', name='진짜 가족사진', type='lore_clue', description='인형이 되기 전, 가족들의 진짜 얼굴이 담긴 빛바랜 사진.', acquire={'method': 'unlock', 'condition': 'area.hallway.frame_inspected == true or area.garden.doghouse_dug == true'}, use={'actions': [{'label': '과거 상기시키기', 'notes': '새아빠와 동생의 인형 본능에 균열을 내는 핵심 트리거.', 'effects': [{'type': 'stat_add', 'value': 30, 'target': 'npc.target.humanity'}, {'type': 'stat_sub', 'value': 10, 'target': 'npc.target.affection'}], 'action_id': 'show_to_npc', 'allowed_when': "npc.target.id != 'stepmother'"}]}), ItemSchema(item_id='warm_black_tea', name='따뜻한 홍차', type='consumable', description='새엄마가 매일 정성스레 준비하는 차. 달콤하지만 끝맛이 비리다.', acquire={'method': 'start', 'condition': "system.time == 'morning' or system.time == 'evening'"}, use={'actions': [{'label': '차 마시기', 'notes': '기력을 회복시켜주지만 서서히 인간성을 잃게 만드는 함정 아이템.', 'effects': [{'type': 'stat_add', 'value': 20, 'target': 'player.stamina'}, {'type': 'stat_sub', 'value': 5, 'target': 'player.humanity', 'permanent': True}], 'action_id': 'drink', 'allowed_when': 'true'}]}), ItemSchema(item_id='dried_herbs', name='말린 허브 뭉치', type='consumable', description='강한 향을 내는 약초 뭉치. 정신을 맑게 해주는 효능이 있다.', acquire={'method': 'unlock', 'condition': 'area.garden.searched == true or area.basement.shelf_inspected == true'}, use={'actions': [{'label': '향기 들이마시기', 'notes': '인형화를 늦추는 유일한 정화 수단.', 'effects': [{'type': 'stat_add', 'value': 5, 'target': 'player.humanity'}], 'action_id': 'inhale_scent', 'allowed_when': 'player.humanity < 100'}]}), ItemSchema(item_id='dog_treat', name='강아지 간식', type='gift', description='바론이 가장 좋아하는 육포. 주방 찬장에 숨겨져 있었다.', acquire={'method': 'unlock', 'condition': 'area.kitchen.cabinet_searched == true'}, use={'actions': [{'label': '바론에게 주기', 'notes': '호감도 상승 시 바론이 감시자(새엄마/새아빠)의 위치를 소리로 알려줌.', 'effects': [{'type': 'stat_add', 'value': 25, 'target': 'npc.baron.affection'}, {'type': 'trigger_event', 'event_id': 'baron_alert_active'}], 'action_id': 'feed_baron', 'allowed_when': "area.current == 'garden'"}]}), ItemSchema(item_id='industrial_sedative', name='공업용 수면제', type='tool', description='강력한 진정 효과가 있는 액체 약물. 주의가 필요하다.', acquire={'method': 'reward', 'condition': 'area.kitchen.locked_cabinet.unlocked == true'}, use={'actions': [{'label': '음식에 타기', 'notes': '특정 NPC를 3턴간 무력화하여 자유로운 탐색 기회를 확보.', 'effects': [{'type': 'set_state', 'value': 'sleeping', 'target': 'npc.target.status', 'duration': 3}], 'action_id': 'spike_food', 'allowed_when': "system.phase == 'evening_prep'"}]}), ItemSchema(item_id='oil_and_lighter', name='기름병과 라이터', type='quest_item', description='불을 붙일 수 있는 도구 세트. 위험한 상황을 초래할 수 있다.', acquire={'method': 'unlock', 'condition': 'has_item(oil_bottle) and has_item(lighter)'}, use={'actions': [{'label': '방화하기', 'notes': '혼돈의 밤 엔딩 진입을 위한 필수 행동.', 'effects': [{'key': 'house_status', 'type': 'set_env', 'value': 'chaos'}, {'type': 'unlock_ending', 'ending_id': 'chaotic_breakout'}], 'action_id': 'start_fire', 'allowed_when': "area.current == 'living_room' or area.current == 'kitchen'"}]}), ItemSchema(item_id='lubricant_oil', name='윤활유', type='tool', description='기계 마찰을 줄여주는 기름. 삐걱거리는 곳에 효과적이다.', acquire={'method': 'unlock', 'condition': 'area.backyard.storage_searched == true'}, use={'actions': [{'label': '기름칠하기', 'notes': '야간 행동 시 NPC에게 들킬 확률(소음 발생률)을 크게 낮춤.', 'effects': [{'key': 'stealth_bonus', 'type': 'var_add', 'value': 15}], 'action_id': 'apply_to_door', 'allowed_when': 'true'}]}), ItemSchema(item_id='mothers_key', name='엄마의 열쇠', type='key', description='새엄마의 목에 걸려 있던 정교한 열쇠. 개구멍의 자물쇠와 맞는다.', acquire={'method': 'reward', 'condition': "npc.stepmother.status == 'sleeping' or npc.brother.affection == 100"}, use={'actions': [{'label': '탈출구 개방', 'notes': '개구멍을 통해 현실 세계로 돌아가는 문을 여는 최종 아이템.', 'effects': [{'type': 'change_scene', 'target': 'ending_sequence'}], 'action_id': 'unlock_exit', 'allowed_when': "area.current == 'player_room' and target == 'dog_hole'"}]})])), arg3_logic_context=LogicContextSchema(meta={'title': '인형의 집 (Puppet Home)', 'genre': 'AI 기반 자유 서술 심리 스릴러', 'tone': '기괴하고 상냥한, 서서히 조여오는 압박감', 'pov': '2nd'}, state={'turn': 1, 'vars': {'day': 1, 'humanity': 100, 'house_on_fire': 0, 'suspicion_level': 0, 'trust': 5, 'clue_count': 1}, 'flags': {'act': 1, 'ending': None, 'truth_revealed': False, 'basement_unlocked': False}, 'active_events': []}, rules={'global_rules': ["플레이어의 모든 자유 서술은 현재 '상태(결박/위치)'와 '현실성' 검증을 거친 후 판정", "NPC는 '밤의 대화'를 통해 플레이어의 낮 행동을 공유하고 다음 날의 태도를 결정", '인간성(Humanity)이 0이 되는 즉시 모든 행동 우선권을 상실하고 엔딩 시퀀스로 강제 진입', "엔진이 확정한 '저택의 비밀' 외에 플레이어가 임의로 가공의 탈출구를 생성하는 것 금지"], 'victory_conditions': ["ending == 'stealth_exit'", "ending == 'chaotic_breakout'", "ending == 'sibling_sacrifice'"], 'failure_conditions': ["ending == 'unfinished_doll'", "ending == 'eternal_dinner'"], 'endings': [{'name': '완벽한 기만 (The Stealth Exit)', 'condition': "has_item(industrial_sedative) and has_item(mothers_key) and npc.stepmother.status == 'sleeping' and system.turn >= 40", 'ending_id': 'stealth_exit', 'epilogue_prompt': '조용하고 서늘하게, 뒤도 돌아보지 않고 안개 속으로 사라지는 주인공을 묘사하라.', 'on_enter_events': [{'key': 'ending', 'type': 'flag_set', 'value': 'stealth_exit'}]}, {'name': '혼돈의 밤 (The Chaotic Breakout)', 'condition': 'has_item(oil_and_lighter) and vars.house_on_fire == true and npc.grandmother.humanity >= 50', 'ending_id': 'chaotic_breakout', 'epilogue_prompt': '타오르는 저택의 불길과 인형들의 비명, 파괴를 통한 자유의 희열을 묘사하라.', 'on_enter_events': [{'key': 'ending', 'type': 'flag_set', 'value': 'chaotic_breakout'}]}, {'name': "조력자의 희생 (The Sibling's Help)", 'condition': 'npc.brother.affection >= 90 and npc.brother.humanity >= 70 and vars.day == 5', 'ending_id': 'sibling_sacrifice', 'epilogue_prompt': '동생의 슬픈 미소와 주인공의 죄책감, 눈물 젖은 탈출을 감성적으로 묘사하라.', 'on_enter_events': [{'key': 'ending', 'type': 'flag_set', 'value': 'sibling_sacrifice'}]}, {'name': '불완전한 박제 (The Unfinished Doll)', 'condition': 'vars.humanity <= 0', 'ending_id': 'unfinished_doll', 'epilogue_prompt': '자아를 잃고 눈동자가 단추로 변해가는 과정과 새엄마의 기쁜 바느질 소리를 묘사하라.', 'on_enter_events': [{'key': 'ending', 'type': 'flag_set', 'value': 'unfinished_doll'}]}, {'name': '영원한 식사 시간 (The Eternal Dinner)', 'condition': 'system.turn == turn_limit and flags.ending == null', 'ending_id': 'eternal_dinner', 'epilogue_prompt': '맛이 느껴지지 않는 고기를 씹으며 가짜 가족들과 영원히 웃고 있는 비극을 묘사하라.', 'on_enter_events': [{'key': 'ending', 'type': 'flag_set', 'value': 'eternal_dinner'}]}]}), arg4_model_config=ModelConfigSchema(model_name='gpt-4-turbo', temperature=0.7, extra_settings={}))}

  File "/Users/juhpark/Documents/maratang/demo-repository/app/api/routes/v1/game.py", line 56, in step_game
    POST /api/v1/game/{game_id}/step
WARNING:  StatReload detected changes in 'app/services/game.py'. Reloading...
INFO:     Shutting down
INFO:     Waiting for application shutdown.
2026-02-06 13:58:36,183 - app.main - INFO - Shutting down scenario server...
INFO:     Application shutdown complete.
INFO:     Finished server process [53447]
/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/pydantic/_internal/_config.py:383: UserWarning: Valid config keys have changed in V2:
* 'orm_mode' has been renamed to 'from_attributes'
  warnings.warn(message, UserWarning)
INFO:     Started server process [53784]
INFO:     Waiting for application startup.
2026-02-06 13:58:36,632 - app.main - INFO - Starting scenario server...
2026-02-06 13:58:36,632 - app.main - INFO - Scenarios path: /Users/juhpark/Documents/maratang/demo-repository/scenarios
2026-02-06 13:58:36,632 - app.main - INFO - Available scenarios: ['coraline', 'culprit_ai', 'zzapraline']
INFO:     Application startup complete.
DEBUG: LLM received input: string
INFO:     115.95.186.2:0 - "POST /api/v1/game/2/step HTTP/1.1" 200 OK
DEBUG: LLM received input: asdfasdf
INFO:     222.109.42.88:0 - "POST /api/v1/game/1/step HTTP/1.1" 200 OK
DEBUG: LLM received input: dfdfdfd
INFO:     222.109.42.88:0 - "POST /api/v1/game/1/step HTTP/1.1" 200 OK
INFO:     127.0.0.1:51752 - "GET /docs HTTP/1.1" 200 OK
INFO:     127.0.0.1:51752 - "GET /openapi.json HTTP/1.1" 200 OK
INFO:     127.0.0.1:51752 - "GET /docs HTTP/1.1" 200 OK
INFO:     127.0.0.1:51752 - "GET /openapi.json HTTP/1.1" 200 OK
WARNING:  StatReload detected changes in 'app/schemas/llm_response_schema.py'. Reloading...
INFO:     Shutting down
INFO:     Waiting for application shutdown.
2026-02-06 14:11:01,506 - app.main - INFO - Shutting down scenario server...
INFO:     Application shutdown complete.
INFO:     Finished server process [53784]
/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/pydantic/_internal/_config.py:383: UserWarning: Valid config keys have changed in V2:
* 'orm_mode' has been renamed to 'from_attributes'
  warnings.warn(message, UserWarning)
INFO:     Started server process [56527]
INFO:     Waiting for application startup.
2026-02-06 14:11:02,032 - app.main - INFO - Starting scenario server...
2026-02-06 14:11:02,032 - app.main - INFO - Scenarios path: /Users/juhpark/Documents/maratang/demo-repository/scenarios
2026-02-06 14:11:02,032 - app.main - INFO - Available scenarios: ['coraline', 'culprit_ai', 'zzapraline']
INFO:     Application startup complete.
WARNING:  StatReload detected changes in 'app/schemas/llm_response_schema.py'. Reloading...
INFO:     Shutting down
INFO:     Waiting for application shutdown.
2026-02-06 14:11:14,575 - app.main - INFO - Shutting down scenario server...
INFO:     Application shutdown complete.
INFO:     Finished server process [56527]
/opt/anaconda3/envs/maratang_env/lib/python3.11/site-packages/pydantic/_internal/_config.py:383: UserWarning: Valid config keys have changed in V2:
* 'orm_mode' has been renamed to 'from_attributes'
  warnings.warn(message, UserWarning)
INFO:     Started server process [56573]
INFO:     Waiting for application startup.
2026-02-06 14:11:14,978 - app.main - INFO - Starting scenario server...
2026-02-06 14:11:14,978 - app.main - INFO - Scenarios path: /Users/juhpark/Documents/maratang/demo-repository/scenarios
2026-02-06 14:11:14,978 - app.main - INFO - Available scenarios: ['coraline', 'culprit_ai', 'zzapraline']
INFO:     Application startup complete.
