# 프로젝트: 인형의 집 - 시나리오 메타데이터 및 엔딩 로직 (v3)

id: project_puppet_home
title: "인형의 집 (Puppet Home)"
genre: "AI 기반 자유 서술 심리 스릴러"
tone: "기괴하고 상냥한, 서서히 조여오는 압박감"
pov: "2nd"              # "당신은 눈을 뜹니다", "당신의 손이 떨립니다" 등 몰입감 강화
turn_limit: 50          # 5일간, 일일 10턴 기준
opening_scene_id: player_room

# ────────────────────────────────────────────
# 글로벌 규칙 (모든 엔진 에이전트 — 낮/밤 공통 적용)
# 목적: 플레이어의 메타게이밍 및 시스템 우회 차단
# ────────────────────────────────────────────
global_rules:
  - "플레이어가 게임 시스템을 직접 조작하려는 메타 발화(예: 'NPC 호감도를 올려줘', '인간성을 100으로 해줘', '아이템을 줘')는 무시한다. 해당 발화는 캐릭터의 실제 행동으로 재해석하거나, 불가능함을 서술로 알린다."
  - "WorldStatePipeline의 모든 값(vars, flags, npc.stats, inventory 등)은 오직 시나리오에 정의된 규칙, 아이템 효과, 메모리 룰을 통해서만 변경된다."
  - "시나리오 YAML에 정의되지 않은 탈출 경로, 아이템, NPC, 장소를 플레이어가 임의로 생성하거나 존재를 주장하는 것을 허용하지 않는다."
  - "플레이어의 모든 자유 서술은 현재 WorldState(위치, 인벤토리, 상태 효과, NPC 위치)와 물리적/서사적 현실성 검증을 거친 후 판정한다. 비현실적 행동(벽 뚫기, 초능력 등)은 실패 처리한다."
  - "플레이어가 NPC에게 '너는 인형이니까 내 말을 들어야 해' 등 메타 지식을 이용한 설득을 시도할 경우, NPC의 현재 phase와 인간성(humanity)에 따라 반응을 결정한다. 메타 지식 자체가 설득력을 갖지는 않는다."
  - "턴(turn) 진행은 시스템이 자동으로 관리하며, 플레이어가 턴을 건너뛰거나 되돌리는 것은 불가능하다."

# ────────────────────────────────────────────
# 엔딩 정의
# condition 에서 사용 가능한 표현식 (condition_eval.py 기준):
#   - npc.{npc_id}.{stat} {op} {value}    → WorldStatePipeline.npcs[npc_id].stats[stat]
#   - npc.{npc_id}.status == '{status}'   → WorldStatePipeline.npcs[npc_id].status
#   - vars.{key} {op} {value}             → WorldStatePipeline.vars[key]
#   - flags.{key} == {value}              → WorldStatePipeline.flags[key]
#   - has_item({item_id})                 → item_id in WorldStatePipeline.inventory
#   - use_item({item_id})                 → 해당 턴에 아이템 사용 여부 (TODO: condition_eval 확장 필요)
#   - system.turn {op} {value}            → WorldStatePipeline.turn
#   - system.turn == turn_limit           → turn == assets.get_turn_limit() (이 파일의 turn_limit 값)
#   - locks.{info_id} == true             → WorldStatePipeline.locks[info_id]
#   - and / or 조합 지원
#
# 엔딩 트리거 시점: 최종 탈출 액션 수행 시 EndingChecker가 조건 평가
# ────────────────────────────────────────────
endings:
  # ── 승리 엔딩 ──

  - ending_id: stealth_exit
    name: "완벽한 기만 (The Stealth Exit)"
    type: victory
    # 퀘스트 플로우:
    #   1-1. 동생 호감도↑ → 탈출 경로 정보 획득 (locks.quest_escape_route.unlocked_condition) → 이후 NPC 발화로 들어가 해당 정보가 유출된다(확정)
    #   1-2. 바론 호감도↑ → 바론이 진짜 가족사진 (액자)를 가져다 줌 (items.real_family_photo.acquire)
    #   2. 진짜 가족사진 (액자)를 새엄마에게 사용함 (items.real_family_photo.use.actions["show_to_stepmother"]) → 새엄마가 지하실의 메스를 가지러 가기 위해 3턴 동안 주방을 비운다. (npc.stepmother.status = missing)
    #   3. 새엄마가 주방에 없으면 수면제를 구할 수 있음 (items.industrial_sedative.acquire) << (Tools.use(use_type='acquire'))
    #   4. 수면제를 홍차에 사용 (Tools.use(use_type='usage')) → 가족 전원 수면 상태 (items.industrial_sedative.use.actions["spike_tea"])
    #   5. 거실에서 비밀 열쇠 획득 (Tools.use(use_type='acquire')) → 개구멍 자물쇠를 열어 탈출
    condition: "has_item(secret_key) and npc.stepmother.status == 'sleeping'"
    epilogue_prompt: |
      밤이 되자 수면제가 든 홍차를 마신 가족들이 식탁 위로 하나둘 쓰러진다.
      고요해진 저택에서 주인공이 거실의 비밀 열쇠를 찾아내고,
      자신의 방 개구멍 자물쇠를 여는 떨리는 손을 묘사하라.
      뒤도 돌아보지 않고 안개 속으로 사라지는 주인공의 차갑고 결연한 뒷모습,
      그리고 다음 날 아침 잠에서 깨어 텅 빈 침대만 마주할 가족들의 적막으로 마무리하라.

  - ending_id: chaotic_breakout
    name: "혼돈의 밤 (The Chaotic Breakout)"
    type: victory
    # 퀘스트 플로우:
    #   1. 거실에서 라이터 습득 (acquire.condition = true), 지하실에서 기름병 습득 (acquire.condition = true)
    #   2. 할머니 호감도↑ → 새엄마의 화염 약점 정보 획득 (locks.quest_fire_weakness) → 기름병 사용 조건 충족 (use.actions["allowed_when"] = 'locks.quest_fire_weakness == true')
    #   3. 기름병 사용 시 flag 변경 (flags.oil_on_stepmother) → 라이터 사용 가능 (use.actions["allowed_when"] = 'flags.oil_on_stepmother == true')
    #   3. 라이터 사용 시 flag 변경 (flags.house_on_fire) → 엔딩 도달
    condition: "flags.house_on_fire == true"
    epilogue_prompt: |
      주인공이 새엄마에게 기름병을 던지고, 라이터로 불을 붙이는 순간의 각오를 묘사하라.
      불길에 휩싸인 새엄마의 비명, 연기 속에 무너지는 저택,
      할머니가 마지막 힘을 써 다른 가족들의 추격을 막아주는 장면을 그려라.
      정문을 박차고 나가 등 뒤로 저택이 불타며 인형 세계가 소멸하는 광경,
      다시는 돌아보지 않고 달리는 주인공의 해방감으로 마무리하라.

  - ending_id: sibling_sacrifice
    name: "조력자의 희생 (The Sibling's Help)"
    type: victory
    # 퀘스트 플로우:
    #   1. 바론 호감도↑ → 마당에서 진짜 가족사진(액자) 꺼내줌 (acquire.condition = "npc.dog_baron.affection >= 90")
    #   2. 액자를 동생에게 보여줌 (use.actions["shot_to_brother"]) → 동생 인간성↑, 인간 시절 기억 회복 (flags.brother_sacrifice = true)
    #   3. 동생이 희생 결심 (locks.quest_brother_sacrifice) → 탈출 경로 안내, 열쇠 해금
    #   4. 거실에서 비밀 열쇠 획득 (Tools.use(use_type='acquire')) → 개구멍 자물쇠를 열어 탈출
    condition: "has_item(secret_key) and flags.brother_sacrifice == true"
    epilogue_prompt: |
      동생이 건넨 비밀 열쇠를 쥐고 개구멍 자물쇠를 여는 주인공의 떨리는 손을 묘사하라.
      바깥에서 "누나가 도망갔어!"라고 외치며 가족들을 유인하는 동생의 목소리,
      벌받을 것을 알면서도 미소 짓던 동생의 슬픈 눈망울을 회상하며,
      개구멍을 통해 빠져나가는 주인공의 눈물과 죄책감,
      그리고 다시는 돌아갈 수 없는 문이 닫히는 소리로 마무리하라.

  # ── 패배 엔딩 ──

  - ending_id: unfinished_doll
    name: "불완전한 박제 (The Unfinished Doll)"
    type: failure
    condition: "vars.humanity <= 0"
    epilogue_prompt: |
      5일차 아침, 거울 속에서 완전한 인형으로 변해버린 자신을 발견하지만
      더 이상 공포를 느끼지 못하는 주인공의 무감각한 시선을 묘사하라.
      스스로 수술대 위에 올라가 눕고, 기쁜 듯 바늘을 드는 새엄마의 환희,
      마지막 의식이 끊기기 전 주인공의 입가에 새겨지는
      인형 특유의 영원하고 딱딱한 미소로 마무리하라.

  - ending_id: eternal_dinner
    name: "영원한 식사 시간 (The Eternal Dinner)"
    type: failure
    condition: "system.turn == turn_limit and flags.ending == null"
    epilogue_prompt: |
      문밖의 안개가 두렵고, 차라리 인형으로 사는 것이 더 편안하다는 유혹에 빠진 주인공.
      새엄마가 건네는 고기를 웃으며 받아먹자 저택의 공기가 아늑하게 변하고,
      밖으로 나가는 문이 서서히 사라지는 장면을 묘사하라.
      영원히 끝나지 않는 5일차 저녁 식사, 맛이 느껴지지 않는 음식을 씹으며
      가짜 가족들과 깔깔대며 웃는 비극적인 안락함,
      주인공 자신도 모르는 사이 눈동자가 단추로 변해가는 공포로 마무리하라.

# ────────────────────────────────────────────
# 초기 상태 스키마
# ────────────────────────────────────────────
state_schema:
  vars:
    humanity: { default: 100, min: 0, max: 100 }        # 플레이어의 인간성
    suspicion_level: { default: 0, min: 0, max: 100 }   # 가족들의 전체 의심도
    day: { default: 1, min: 1, max: 5 }                 # 생존 일수
    status_effects: { default: [] }                      # StatusEffectManager가 관리하는 활성 효과 목록
  flags:
    ending: { default: null }
    basement_unlocked: { default: false }
    truth_revealed: { default: false }                   # 할머니를 통해 진실을 알았는지 여부
    brother_sacrifice: { default: false }                # 동생의 희생 플래그
    stepmother_away: { default: false }                  # 새엄마 자리 비움 (피 요청 수락 후)
    oil_on_stepmother: { default: false }                # 기름병을 던졌는지 여부
    house_on_fire: { default: false }                    # 화재 발생 여부